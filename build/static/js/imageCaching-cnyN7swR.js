import{a as d}from"./react-core-DA61mcWm.js";import"./ui-vendor-BrUQ4r0A.js";import"./editor-vendor-D9c4a6XZ.js";const w="pawscord-image-cache",C="v1",y=50*1024*1024,u=10080*60*1e3,o=new Map,f=new Map;class A{constructor(){this.cache=new Map,this.loadFromLocalStorage()}loadFromLocalStorage(){try{const t=localStorage.getItem(`${w}-${C}`);if(t){const a=JSON.parse(t);Object.entries(a).forEach(([e,c])=>{this.isValidCacheEntry(c)&&this.cache.set(e,c)})}}catch{this.clearCache()}}saveToLocalStorage(){try{const t=Object.fromEntries(this.cache);localStorage.setItem(`${w}-${C}`,JSON.stringify(t))}catch{this.pruneCache()}}isValidCacheEntry(t){return!t||!t.timestamp?!1:Date.now()-t.timestamp<u}async get(t){const a=this.cache.get(t);return a&&this.isValidCacheEntry(a)?(a.lastAccessed=Date.now(),this.saveToLocalStorage(),a.data):(a&&this.cache.delete(t),null)}async set(t,a){const e=this.getCacheSize(),c=new Blob([a]).size;e+c>y&&this.pruneCache(),this.cache.set(t,{data:a,timestamp:Date.now(),lastAccessed:Date.now(),size:c}),this.saveToLocalStorage()}getCacheSize(){let t=0;return this.cache.forEach(a=>{t+=a.size||0}),t}pruneCache(){const t=Array.from(this.cache.entries());t.sort((e,c)=>e[1].lastAccessed-c[1].lastAccessed);const a=Math.ceil(t.length*.3);for(let e=0;e<a;e++)this.cache.delete(t[e][0]);this.saveToLocalStorage()}clearCache(){this.cache.clear();try{localStorage.removeItem(`${w}-${C}`)}catch{}}async prefetch(t){const a=t.map(async e=>{if(!this.cache.has(e))try{const n=await(await fetch(e)).blob(),h=await this.blobToDataUrl(n);await this.set(e,h)}catch{}});await Promise.allSettled(a)}blobToDataUrl(t){return new Promise((a,e)=>{const c=new FileReader;c.onload=()=>a(c.result),c.onerror=e,c.readAsDataURL(t)})}getStats(){return{entries:this.cache.size,size:this.getCacheSize(),maxSize:y,usage:(this.getCacheSize()/y*100).toFixed(2)+"%",oldestEntry:Math.min(...Array.from(this.cache.values()).map(t=>t.timestamp)),newestEntry:Math.max(...Array.from(this.cache.values()).map(t=>t.timestamp))}}}const i=new A,I=s=>{const[t,a]=d.useState(()=>s&&o.has(s)?o.get(s):null),[e,c]=d.useState(!t),[n,h]=d.useState(null);return d.useEffect(()=>{let l=!1;return(async()=>{if(!s){c(!1);return}if(o.has(s)){a(o.get(s)),c(!1);return}if(f.has(s)){try{const r=await f.get(s);l||(a(r),c(!1))}catch(r){l||(h(r),a(s),c(!1))}return}const m=(async()=>{try{c(!0);const r=await i.get(s);if(r)return o.set(s,r),r;const g=await fetch(s);if(!g.ok)throw new Error("Image fetch failed");const b=await g.blob(),p=await i.blobToDataUrl(b);return await i.set(s,p),o.set(s,p),p}finally{f.delete(s)}})();f.set(s,m);try{const r=await m;l||(a(r),c(!1))}catch(r){l||(h(r),a(s),c(!1))}})(),()=>{l=!0}},[s]),{url:t,loading:e,error:n}},U=async s=>{const a={profile:["/avatars/cat_1.png"],home:["/static/logo.png"]}[s]||[];await i.prefetch(a)},D=()=>{i.clearCache(),o.clear(),f.clear()},M=()=>({...i.getStats(),inMemoryCount:o.size,pendingLoads:f.size}),$=async s=>{if(!s||!Array.isArray(s))return;const t=s.map(e=>e.avatar_url||e.avatar).filter(e=>e&&typeof e=="string"&&e.startsWith("http")).filter(e=>!o.has(e));if(t.length===0)return;const a=5;for(let e=0;e<t.length;e+=a){const c=t.slice(e,e+a);await Promise.allSettled(c.map(async n=>{if(!o.has(n))try{const h=await i.get(n);if(h){o.set(n,h);return}const l=`?_=${Date.now()}`,S=n.includes("?")?`${n}&_=${Date.now()}`:`${n}${l}`,m=await fetch(S,{mode:"cors",cache:"no-cache"});if(!m.ok)return;const r=await m.blob(),g=await i.blobToDataUrl(r);await i.set(n,g),o.set(n,g)}catch{}}))}},L=s=>s&&o.get(s)||null;export{D as clearImageCache,i as default,L as getAvatarFromCache,M as getImageCacheStats,U as prefetchRouteImages,$ as prefetchUserAvatars,I as useCachedImage};
