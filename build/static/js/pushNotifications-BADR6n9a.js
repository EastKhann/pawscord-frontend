const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BhYSFoQU.js","./index-D_6pZib5.js","./react-core-B6hadH-M.js","../css/react-core-Dj12pvTl.css","../css/index-CMOBsU3t.css"])))=>i.map(i=>d[i]);
import{_ as o}from"./react-core-B6hadH-M.js";class r{constructor(){this.isSupported="PushManager"in window,this.permission="default",this.deviceToken=null,this.listeners=new Map}async init(i,e){this.apiBaseUrl=i,this.fetchWithAuth=e,window.Capacitor?.isNativePlatform()?await this.initCapacitor():await this.initWeb()}async initCapacitor(){try{const{PushNotifications:i}=await o(async()=>{const{PushNotifications:t}=await import("./index-BhYSFoQU.js");return{PushNotifications:t}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);(await i.requestPermissions()).receive==="granted"&&(this.permission="granted",await i.register(),await i.addListener("registration",async t=>{this.deviceToken=t.value,await this.registerDevice(t.value)}),await i.addListener("registrationError",t=>{console.error("üîî [Push] Registration error:",t)}),await i.addListener("pushNotificationReceived",t=>{this.handleNotification(t)}),await i.addListener("pushNotificationActionPerformed",t=>{this.handleNotificationAction(t)}))}catch(i){console.error("‚ùå [Push] Capacitor init failed:",i)}}async initWeb(){if(!this.isSupported){console.warn("‚ö†Ô∏è [Push] Web push not supported");return}const i=await Notification.requestPermission();this.permission=i}async registerDevice(i){try{(await this.fetchWithAuth(`${this.apiBaseUrl}/devices/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registration_id:i,type:"android",active:!0})})).ok}catch(e){console.error("‚ùå [Push] Device registration failed:",e)}}handleNotification(i){const{title:e,body:t,data:s}=i;this.listeners.forEach(a=>{a({type:"notification",title:e,body:t,data:s})}),document.hidden&&this.permission==="granted"&&new Notification(e,{body:t,icon:"/logo192.png",badge:"/badge.png",tag:s?.messageId||"default",data:s})}handleNotificationAction(i){const{notification:e,actionId:t}=i;this.listeners.forEach(s=>{s({type:"action",actionId:t,notification:e})}),e.data?.roomId?window.location.href=`/#/room/${e.data.roomId}`:e.data?.conversationId&&(window.location.href=`/#/dm/${e.data.conversationId}`)}on(i,e){const t=Math.random().toString(36).substr(2,9);return this.listeners.set(t,e),()=>this.listeners.delete(t)}async sendTestNotification(){try{await this.fetchWithAuth(`${this.apiBaseUrl}/push/test/`,{method:"POST"})}catch(i){console.error("‚ùå [Push] Test failed:",i)}}async unregister(){if(this.deviceToken)try{await this.fetchWithAuth(`${this.apiBaseUrl}/devices/${this.deviceToken}/`,{method:"DELETE"})}catch(i){console.error("‚ùå [Push] Unregister failed:",i)}}}const h=new r;export{h as pushNotificationManager};
