import{r as l,n as s}from"./react-core-BMiyQWF6.js";import{y as i}from"./ui-vendor-6RMGJYFH.js";import{g as E}from"./index-BroE2O5W.js";import"./editor-vendor-D9c4a6XZ.js";import"./media-vendor-BuSyE8vR.js";import"./router-vendor-B86Z1mIL.js";import"./icons-vendor-GUGjkvMm.js";import"./state-vendor-CAyNnPM4.js";import"./crypto-vendor-1Q6e4ZD-.js";const V=({serverId:d,onClose:x})=>{const n=E(),[j,_]=l.useState([]),[S,w]=l.useState(!0),[t,o]=l.useState({enabled:!1,category_id:"",support_role_id:"",max_tickets_per_user:3,auto_close_after:48,transcript_channel_id:"",welcome_message:"Merhaba! Destek ekibimiz en kÄ±sa sÃ¼rede size yardÄ±mcÄ± olacak."}),[T,$]=l.useState([]),[C,A]=l.useState([]),[B,z]=l.useState([]),[c,m]=l.useState(null),[p,k]=l.useState("");l.useEffect(()=>{O(),g(),P(),K(),D()},[d]);const O=async()=>{try{const e=await fetch(`${n}/tickets/server/${d}/config/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();o(a)}}catch{}},g=async()=>{try{const e=await fetch(`${n}/tickets/server/${d}/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();_(a)}}catch{}finally{w(!1)}},P=async()=>{try{const e=await fetch(`${n}/channels/server/${d}/categories/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();$(a)}}catch{}},K=async()=>{try{const e=await fetch(`${n}/roles/server/${d}/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();A(a)}}catch{}},D=async()=>{try{const e=await fetch(`${n}/channels/server/${d}/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();z(a.filter(r=>r.type==="text"))}}catch{}},M=async()=>{try{(await fetch(`${n}/tickets/server/${d}/config/update/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},body:JSON.stringify(t)})).ok?i.success("âœ… Ayarlar gÃ¼ncellendi"):i.error("âŒ Ayarlar gÃ¼ncellenemedi")}catch{i.error("âŒ BaÄŸlantÄ± hatasÄ±")}},f=async e=>{if(window.confirm("Ticket'Ä± kapatmak istediÄŸinize emin misiniz?"))try{(await fetch(`${n}/tickets/${e}/close/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}})).ok?(i.success("âœ… Ticket kapatÄ±ldÄ±"),g(),c?.id===e&&m(null)):i.error("âŒ Ticket kapatÄ±lamadÄ±")}catch{i.error("âŒ BaÄŸlantÄ± hatasÄ±")}},R=async(e,a)=>{try{(await fetch(`${n}/tickets/${e}/priority/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},body:JSON.stringify({priority:a})})).ok?(i.success("âœ… Ã–ncelik gÃ¼ncellendi"),g()):i.error("âŒ Ã–ncelik gÃ¼ncellenemedi")}catch{i.error("âŒ BaÄŸlantÄ± hatasÄ±")}},y=async()=>{if(p.trim())try{const e=await fetch(`${n}/tickets/${c.id}/reply/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},body:JSON.stringify({message:p})});if(e.ok){const a=await e.json();m({...c,messages:[...c.messages||[],a.message]}),k(""),i.success("âœ… Mesaj gÃ¶nderildi")}else i.error("âŒ Mesaj gÃ¶nderilemedi")}catch{i.error("âŒ BaÄŸlantÄ± hatasÄ±")}},I=async e=>{try{const a=await fetch(`${n}/tickets/${e}/transcript/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(a.ok){const r=await a.blob(),u=window.URL.createObjectURL(r),h=document.createElement("a");h.href=u,h.download=`ticket-${e}-transcript.txt`,h.click(),i.success("âœ… Transcript indirildi")}else i.error("âŒ Transcript indirilemedi")}catch{i.error("âŒ BaÄŸlantÄ± hatasÄ±")}},N=e=>{const a={open:{text:"AÃ§Ä±k",color:"#10b981"},assigned:{text:"AtandÄ±",color:"#f59e0b"},closed:{text:"KapalÄ±",color:"#6b7280"}};return a[e]||a.open},v=e=>{const a={low:{text:"DÃ¼ÅŸÃ¼k",color:"#10b981"},medium:{text:"Orta",color:"#f59e0b"},high:{text:"YÃ¼ksek",color:"#ef4444"},urgent:{text:"Acil",color:"#dc2626"}};return a[e]||a.medium},b=e=>{const a=new Date(e);return new Intl.DateTimeFormat("tr-TR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(a)};return s.jsx("div",{className:"ticket-panel-overlay",onClick:x,children:s.jsxs("div",{className:"ticket-panel",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"ticket-header",children:[s.jsx("h2",{children:"ðŸŽ« Destek Sistemi"}),s.jsx("button",{className:"close-btn",onClick:x,children:"Ã—"})]}),s.jsxs("div",{className:"ticket-content",children:[s.jsxs("div",{className:"ticket-config-section",children:[s.jsx("h3",{children:"âš™ï¸ Sistem AyarlarÄ±"}),s.jsxs("div",{className:"config-grid",children:[s.jsx("div",{className:"config-item",children:s.jsxs("label",{className:"toggle-label",children:[s.jsx("input",{type:"checkbox",checked:t.enabled,onChange:e=>o({...t,enabled:e.target.checked})}),s.jsx("span",{className:"toggle-switch"}),s.jsx("span",{className:"toggle-text",children:"Ticket Sistemi Aktif"})]})}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Ticket Kategorisi"}),s.jsxs("select",{value:t.category_id,onChange:e=>o({...t,category_id:e.target.value}),children:[s.jsx("option",{value:"",children:"Kategori SeÃ§in"}),T.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Destek RolÃ¼"}),s.jsxs("select",{value:t.support_role_id,onChange:e=>o({...t,support_role_id:e.target.value}),children:[s.jsx("option",{value:"",children:"Rol SeÃ§in"}),C.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"KullanÄ±cÄ± BaÅŸÄ±na Max Ticket"}),s.jsx("input",{type:"number",min:"1",max:"10",value:t.max_tickets_per_user,onChange:e=>o({...t,max_tickets_per_user:parseInt(e.target.value)})})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Otomatik Kapanma (Saat)"}),s.jsx("input",{type:"number",min:"1",max:"168",value:t.auto_close_after,onChange:e=>o({...t,auto_close_after:parseInt(e.target.value)})})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Transcript KanalÄ±"}),s.jsxs("select",{value:t.transcript_channel_id,onChange:e=>o({...t,transcript_channel_id:e.target.value}),children:[s.jsx("option",{value:"",children:"Kanal SeÃ§in (Opsiyonel)"}),B.map(e=>s.jsxs("option",{value:e.id,children:["# ",e.name]},e.id))]})]}),s.jsxs("div",{className:"config-item full-width",children:[s.jsx("label",{children:"HoÅŸ Geldin MesajÄ±"}),s.jsx("textarea",{value:t.welcome_message,onChange:e=>o({...t,welcome_message:e.target.value}),rows:"3"})]})]}),s.jsx("button",{className:"save-config-btn",onClick:M,children:"ðŸ’¾ AyarlarÄ± Kaydet"})]}),s.jsxs("div",{className:"tickets-section",children:[s.jsx("h3",{children:"ðŸ“‹ Aktif Ticket'lar"}),S?s.jsxs("div",{className:"loading-state",children:[s.jsx("div",{className:"spinner"}),s.jsx("p",{children:"Ticket'lar yÃ¼kleniyor..."})]}):j.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("span",{className:"empty-icon",children:"ðŸŽ«"}),s.jsx("p",{children:"HenÃ¼z ticket yok"}),s.jsx("span",{className:"empty-hint",children:"KullanÄ±cÄ±lar ticket oluÅŸturduÄŸunda burada gÃ¶rÃ¼necek"})]}):s.jsx("div",{className:"tickets-grid",children:j.map(e=>s.jsxs("div",{className:"ticket-card",onClick:()=>m(e),children:[s.jsxs("div",{className:"ticket-card-header",children:[s.jsxs("div",{className:"ticket-info",children:[s.jsxs("span",{className:"ticket-id",children:["#",e.id]}),s.jsx("h4",{children:e.subject||"Destek Talebi"})]}),s.jsxs("div",{className:"ticket-badges",children:[s.jsx("span",{className:"status-badge",style:{background:N(e.status).color},children:N(e.status).text}),s.jsx("span",{className:"priority-badge",style:{background:v(e.priority).color},children:v(e.priority).text})]})]}),s.jsxs("div",{className:"ticket-meta",children:[s.jsxs("div",{className:"meta-item",children:[s.jsx("span",{className:"meta-label",children:"OluÅŸturan:"}),s.jsx("span",{className:"meta-value",children:e.creator_username})]}),e.assigned_to&&s.jsxs("div",{className:"meta-item",children:[s.jsx("span",{className:"meta-label",children:"Atanan:"}),s.jsx("span",{className:"meta-value",children:e.assigned_to_username})]}),s.jsxs("div",{className:"meta-item",children:[s.jsx("span",{className:"meta-label",children:"OluÅŸturulma:"}),s.jsx("span",{className:"meta-value",children:b(e.created_at)})]})]}),s.jsxs("div",{className:"ticket-actions-quick",children:[s.jsx("button",{className:"priority-btn",onClick:a=>{a.stopPropagation();const r=["low","medium","high","urgent"],u=r.indexOf(e.priority),h=r[(u+1)%r.length];R(e.id,h)},children:"ðŸ·ï¸ Ã–ncelik"}),s.jsx("button",{className:"close-ticket-btn",onClick:a=>{a.stopPropagation(),f(e.id)},children:"âœ“ Kapat"})]})]},e.id))})]})]}),c&&s.jsx("div",{className:"ticket-detail-modal",onClick:()=>m(null),children:s.jsxs("div",{className:"ticket-detail-panel",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"detail-header",children:[s.jsxs("div",{children:[s.jsxs("span",{className:"ticket-id-large",children:["#",c.id]}),s.jsx("h3",{children:c.subject||"Destek Talebi"})]}),s.jsx("button",{className:"close-btn",onClick:()=>m(null),children:"Ã—"})]}),s.jsxs("div",{className:"detail-body",children:[s.jsx("div",{className:"messages-container",children:c.messages?.map((e,a)=>s.jsxs("div",{className:"message-item",children:[s.jsxs("div",{className:"message-author",children:[s.jsx("span",{className:"author-name",children:e.author}),s.jsx("span",{className:"message-time",children:b(e.created_at)})]}),s.jsx("div",{className:"message-content",children:e.content})]},a))}),s.jsxs("div",{className:"message-input-container",children:[s.jsx("input",{type:"text",placeholder:"MesajÄ±nÄ±zÄ± yazÄ±n...",value:p,onChange:e=>k(e.target.value),onKeyPress:e=>e.key==="Enter"&&y()}),s.jsx("button",{className:"send-btn",onClick:y,children:"ðŸ“¤ GÃ¶nder"})]})]}),s.jsxs("div",{className:"detail-footer",children:[s.jsx("button",{className:"export-btn",onClick:()=>I(c.id),children:"ðŸ“„ Transcript Ä°ndir"}),s.jsx("button",{className:"close-ticket-btn-large",onClick:()=>f(c.id),children:"âœ“ Ticket'Ä± Kapat"})]})]})})]})})};export{V as default};
