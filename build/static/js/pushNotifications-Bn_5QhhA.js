const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CaCodPIs.js","./index--4n6VwUx.js","./react-core-GQV1VuAT.js","../css/react-core-Dj12pvTl.css","../css/index-CQaL4Ahz.css"])))=>i.map(i=>d[i]);
import{_ as a}from"./react-core-GQV1VuAT.js";class n{constructor(){this.isSupported="PushManager"in window,this.permission="default",this.deviceToken=null,this.listeners=new Map}async init(i,e){this.apiBaseUrl=i,this.fetchWithAuth=e,window.Capacitor?.isNativePlatform()?await this.initCapacitor():await this.initWeb()}async initCapacitor(){try{const{PushNotifications:i}=await a(async()=>{const{PushNotifications:t}=await import("./index-CaCodPIs.js");return{PushNotifications:t}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);(await i.requestPermissions()).receive==="granted"&&(this.permission="granted",await i.register(),await i.addListener("registration",async t=>{this.deviceToken=t.value,await this.registerDevice(t.value)}),await i.addListener("registrationError",t=>{console.error("üîî [Push] Registration error:",t)}),await i.addListener("pushNotificationReceived",t=>{console.log("üîî [Push] Notification received:",t),this.handleNotification(t)}),await i.addListener("pushNotificationActionPerformed",t=>{console.log("üîî [Push] Action performed:",t),this.handleNotificationAction(t)}),console.log("‚úÖ [Push] Capacitor notifications initialized"))}catch(i){console.error("‚ùå [Push] Capacitor init failed:",i)}}async initWeb(){if(!this.isSupported){console.warn("‚ö†Ô∏è [Push] Web push not supported");return}const i=await Notification.requestPermission();this.permission=i,i==="granted"&&console.log("‚úÖ [Push] Web notifications enabled")}async registerDevice(i){try{(await this.fetchWithAuth(`${this.apiBaseUrl}/devices/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({registration_id:i,type:"android",active:!0})})).ok&&console.log("‚úÖ [Push] Device registered")}catch(e){console.error("‚ùå [Push] Device registration failed:",e)}}handleNotification(i){const{title:e,body:t,data:o}=i;this.listeners.forEach(s=>{s({type:"notification",title:e,body:t,data:o})}),document.hidden&&this.permission==="granted"&&new Notification(e,{body:t,icon:"/logo192.png",badge:"/badge.png",tag:o?.messageId||"default",data:o})}handleNotificationAction(i){const{notification:e,actionId:t}=i;this.listeners.forEach(o=>{o({type:"action",actionId:t,notification:e})}),e.data?.roomId?window.location.href=`/#/room/${e.data.roomId}`:e.data?.conversationId&&(window.location.href=`/#/dm/${e.data.conversationId}`)}on(i,e){const t=Math.random().toString(36).substr(2,9);return this.listeners.set(t,e),()=>this.listeners.delete(t)}async sendTestNotification(){try{await this.fetchWithAuth(`${this.apiBaseUrl}/push/test/`,{method:"POST"}),console.log("‚úÖ [Push] Test notification sent")}catch(i){console.error("‚ùå [Push] Test failed:",i)}}async unregister(){if(this.deviceToken)try{await this.fetchWithAuth(`${this.apiBaseUrl}/devices/${this.deviceToken}/`,{method:"DELETE"}),console.log("‚úÖ [Push] Device unregistered")}catch(i){console.error("‚ùå [Push] Unregister failed:",i)}}}const h=new n;export{h as pushNotificationManager};
