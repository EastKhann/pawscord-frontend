import{r as o,n as s}from"./react-core-zXIKm1Jm.js";import{y as r}from"./ui-vendor-BGw4w3Ed.js";import{g as I}from"./index-BG_AnZTm.js";import"./editor-vendor-DiU449Dh.js";import"./media-vendor-BSOZ7IB3.js";import"./router-vendor-ltdGXAv4.js";import"./crypto-vendor-D_AcF0lD.js";import"./icons-vendor-BBdoVeJd.js";import"./state-vendor-8NbFPBhQ.js";const V=({serverId:d,onClose:x})=>{const n=I(),[j,_]=o.useState([]),[S,w]=o.useState(!0),[t,l]=o.useState({enabled:!1,category_id:"",support_role_id:"",max_tickets_per_user:3,auto_close_after:48,transcript_channel_id:"",welcome_message:"Merhaba! Destek ekibimiz en kÄ±sa sÃ¼rede size yardÄ±mcÄ± olacak."}),[T,$]=o.useState([]),[C,A]=o.useState([]),[B,z]=o.useState([]),[i,h]=o.useState(null),[g,k]=o.useState("");o.useEffect(()=>{E(),p(),O(),P(),K()},[d]);const E=async()=>{try{const e=await fetch(`${n}/tickets/server/${d}/config/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();l(a)}}catch(e){console.error("Error fetching config:",e)}},p=async()=>{try{const e=await fetch(`${n}/tickets/server/${d}/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();_(a)}}catch(e){console.error("Error fetching tickets:",e)}finally{w(!1)}},O=async()=>{try{const e=await fetch(`${n}/channels/server/${d}/categories/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();$(a)}}catch(e){console.error("Error fetching categories:",e)}},P=async()=>{try{const e=await fetch(`${n}/roles/server/${d}/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();A(a)}}catch(e){console.error("Error fetching roles:",e)}},K=async()=>{try{const e=await fetch(`${n}/channels/server/${d}/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const a=await e.json();z(a.filter(c=>c.type==="text"))}}catch(e){console.error("Error fetching channels:",e)}},D=async()=>{try{(await fetch(`${n}/tickets/server/${d}/config/update/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},body:JSON.stringify(t)})).ok?r.success("âœ… Ayarlar gÃ¼ncellendi"):r.error("âŒ Ayarlar gÃ¼ncellenemedi")}catch(e){console.error("Error updating config:",e),r.error("âŒ BaÄŸlantÄ± hatasÄ±")}},f=async e=>{if(window.confirm("Ticket'Ä± kapatmak istediÄŸinize emin misiniz?"))try{(await fetch(`${n}/tickets/${e}/close/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}})).ok?(r.success("âœ… Ticket kapatÄ±ldÄ±"),p(),i?.id===e&&h(null)):r.error("âŒ Ticket kapatÄ±lamadÄ±")}catch(a){console.error("Error closing ticket:",a),r.error("âŒ BaÄŸlantÄ± hatasÄ±")}},M=async(e,a)=>{try{(await fetch(`${n}/tickets/${e}/priority/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},body:JSON.stringify({priority:a})})).ok?(r.success("âœ… Ã–ncelik gÃ¼ncellendi"),p()):r.error("âŒ Ã–ncelik gÃ¼ncellenemedi")}catch(c){console.error("Error setting priority:",c),r.error("âŒ BaÄŸlantÄ± hatasÄ±")}},y=async()=>{if(g.trim())try{const e=await fetch(`${n}/tickets/${i.id}/reply/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},body:JSON.stringify({message:g})});if(e.ok){const a=await e.json();h({...i,messages:[...i.messages||[],a.message]}),k(""),r.success("âœ… Mesaj gÃ¶nderildi")}else r.error("âŒ Mesaj gÃ¶nderilemedi")}catch(e){console.error("Error sending message:",e),r.error("âŒ BaÄŸlantÄ± hatasÄ±")}},R=async e=>{try{const a=await fetch(`${n}/tickets/${e}/transcript/`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(a.ok){const c=await a.blob(),u=window.URL.createObjectURL(c),m=document.createElement("a");m.href=u,m.download=`ticket-${e}-transcript.txt`,m.click(),r.success("âœ… Transcript indirildi")}else r.error("âŒ Transcript indirilemedi")}catch(a){console.error("Error exporting transcript:",a),r.error("âŒ BaÄŸlantÄ± hatasÄ±")}},N=e=>{const a={open:{text:"AÃ§Ä±k",color:"#10b981"},assigned:{text:"AtandÄ±",color:"#f59e0b"},closed:{text:"KapalÄ±",color:"#6b7280"}};return a[e]||a.open},v=e=>{const a={low:{text:"DÃ¼ÅŸÃ¼k",color:"#10b981"},medium:{text:"Orta",color:"#f59e0b"},high:{text:"YÃ¼ksek",color:"#ef4444"},urgent:{text:"Acil",color:"#dc2626"}};return a[e]||a.medium},b=e=>{const a=new Date(e);return new Intl.DateTimeFormat("tr-TR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(a)};return s.jsx("div",{className:"ticket-panel-overlay",onClick:x,children:s.jsxs("div",{className:"ticket-panel",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"ticket-header",children:[s.jsx("h2",{children:"ðŸŽ« Destek Sistemi"}),s.jsx("button",{className:"close-btn",onClick:x,children:"Ã—"})]}),s.jsxs("div",{className:"ticket-content",children:[s.jsxs("div",{className:"ticket-config-section",children:[s.jsx("h3",{children:"âš™ï¸ Sistem AyarlarÄ±"}),s.jsxs("div",{className:"config-grid",children:[s.jsx("div",{className:"config-item",children:s.jsxs("label",{className:"toggle-label",children:[s.jsx("input",{type:"checkbox",checked:t.enabled,onChange:e=>l({...t,enabled:e.target.checked})}),s.jsx("span",{className:"toggle-switch"}),s.jsx("span",{className:"toggle-text",children:"Ticket Sistemi Aktif"})]})}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Ticket Kategorisi"}),s.jsxs("select",{value:t.category_id,onChange:e=>l({...t,category_id:e.target.value}),children:[s.jsx("option",{value:"",children:"Kategori SeÃ§in"}),T.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Destek RolÃ¼"}),s.jsxs("select",{value:t.support_role_id,onChange:e=>l({...t,support_role_id:e.target.value}),children:[s.jsx("option",{value:"",children:"Rol SeÃ§in"}),C.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"KullanÄ±cÄ± BaÅŸÄ±na Max Ticket"}),s.jsx("input",{type:"number",min:"1",max:"10",value:t.max_tickets_per_user,onChange:e=>l({...t,max_tickets_per_user:parseInt(e.target.value)})})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Otomatik Kapanma (Saat)"}),s.jsx("input",{type:"number",min:"1",max:"168",value:t.auto_close_after,onChange:e=>l({...t,auto_close_after:parseInt(e.target.value)})})]}),s.jsxs("div",{className:"config-item",children:[s.jsx("label",{children:"Transcript KanalÄ±"}),s.jsxs("select",{value:t.transcript_channel_id,onChange:e=>l({...t,transcript_channel_id:e.target.value}),children:[s.jsx("option",{value:"",children:"Kanal SeÃ§in (Opsiyonel)"}),B.map(e=>s.jsxs("option",{value:e.id,children:["# ",e.name]},e.id))]})]}),s.jsxs("div",{className:"config-item full-width",children:[s.jsx("label",{children:"HoÅŸ Geldin MesajÄ±"}),s.jsx("textarea",{value:t.welcome_message,onChange:e=>l({...t,welcome_message:e.target.value}),rows:"3"})]})]}),s.jsx("button",{className:"save-config-btn",onClick:D,children:"ðŸ’¾ AyarlarÄ± Kaydet"})]}),s.jsxs("div",{className:"tickets-section",children:[s.jsx("h3",{children:"ðŸ“‹ Aktif Ticket'lar"}),S?s.jsxs("div",{className:"loading-state",children:[s.jsx("div",{className:"spinner"}),s.jsx("p",{children:"Ticket'lar yÃ¼kleniyor..."})]}):j.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("span",{className:"empty-icon",children:"ðŸŽ«"}),s.jsx("p",{children:"HenÃ¼z ticket yok"}),s.jsx("span",{className:"empty-hint",children:"KullanÄ±cÄ±lar ticket oluÅŸturduÄŸunda burada gÃ¶rÃ¼necek"})]}):s.jsx("div",{className:"tickets-grid",children:j.map(e=>s.jsxs("div",{className:"ticket-card",onClick:()=>h(e),children:[s.jsxs("div",{className:"ticket-card-header",children:[s.jsxs("div",{className:"ticket-info",children:[s.jsxs("span",{className:"ticket-id",children:["#",e.id]}),s.jsx("h4",{children:e.subject||"Destek Talebi"})]}),s.jsxs("div",{className:"ticket-badges",children:[s.jsx("span",{className:"status-badge",style:{background:N(e.status).color},children:N(e.status).text}),s.jsx("span",{className:"priority-badge",style:{background:v(e.priority).color},children:v(e.priority).text})]})]}),s.jsxs("div",{className:"ticket-meta",children:[s.jsxs("div",{className:"meta-item",children:[s.jsx("span",{className:"meta-label",children:"OluÅŸturan:"}),s.jsx("span",{className:"meta-value",children:e.creator_username})]}),e.assigned_to&&s.jsxs("div",{className:"meta-item",children:[s.jsx("span",{className:"meta-label",children:"Atanan:"}),s.jsx("span",{className:"meta-value",children:e.assigned_to_username})]}),s.jsxs("div",{className:"meta-item",children:[s.jsx("span",{className:"meta-label",children:"OluÅŸturulma:"}),s.jsx("span",{className:"meta-value",children:b(e.created_at)})]})]}),s.jsxs("div",{className:"ticket-actions-quick",children:[s.jsx("button",{className:"priority-btn",onClick:a=>{a.stopPropagation();const c=["low","medium","high","urgent"],u=c.indexOf(e.priority),m=c[(u+1)%c.length];M(e.id,m)},children:"ðŸ·ï¸ Ã–ncelik"}),s.jsx("button",{className:"close-ticket-btn",onClick:a=>{a.stopPropagation(),f(e.id)},children:"âœ“ Kapat"})]})]},e.id))})]})]}),i&&s.jsx("div",{className:"ticket-detail-modal",onClick:()=>h(null),children:s.jsxs("div",{className:"ticket-detail-panel",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"detail-header",children:[s.jsxs("div",{children:[s.jsxs("span",{className:"ticket-id-large",children:["#",i.id]}),s.jsx("h3",{children:i.subject||"Destek Talebi"})]}),s.jsx("button",{className:"close-btn",onClick:()=>h(null),children:"Ã—"})]}),s.jsxs("div",{className:"detail-body",children:[s.jsx("div",{className:"messages-container",children:i.messages?.map((e,a)=>s.jsxs("div",{className:"message-item",children:[s.jsxs("div",{className:"message-author",children:[s.jsx("span",{className:"author-name",children:e.author}),s.jsx("span",{className:"message-time",children:b(e.created_at)})]}),s.jsx("div",{className:"message-content",children:e.content})]},a))}),s.jsxs("div",{className:"message-input-container",children:[s.jsx("input",{type:"text",placeholder:"MesajÄ±nÄ±zÄ± yazÄ±n...",value:g,onChange:e=>k(e.target.value),onKeyPress:e=>e.key==="Enter"&&y()}),s.jsx("button",{className:"send-btn",onClick:y,children:"ðŸ“¤ GÃ¶nder"})]})]}),s.jsxs("div",{className:"detail-footer",children:[s.jsx("button",{className:"export-btn",onClick:()=>R(i.id),children:"ðŸ“„ Transcript Ä°ndir"}),s.jsx("button",{className:"close-ticket-btn-large",onClick:()=>f(i.id),children:"âœ“ Ticket'Ä± Kapat"})]})]})})]})})};export{V as default};
