import{r as s,d as e,as as O,i as M,dd as q,aR as I,q as H,m as N,Q as X,U as Z,l as $,E as ee,_ as te}from"./react-core-DrOm_csO.js";import{t as m}from"./index-DmEhdEtw.js";import{Q as ne}from"./index-DUwhheFe.js";async function re(){const t=await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]);return{publicKey:await R(t.publicKey),privateKey:await A(t.privateKey)}}async function ae(t,n){const r=await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]),a=await oe(r.publicKey),l=await ce(a);return{keyId:t,publicKey:await R(r.publicKey),privateKey:await A(r.privateKey),signature:v(l)}}async function ie(t=100){const n=[];for(let r=0;r<t;r++){const a=await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]);n.push({keyId:r,publicKey:await R(a.publicKey),privateKey:await A(a.privateKey)})}return n}async function R(t){const n=await crypto.subtle.exportKey("jwk",t);return JSON.stringify(n)}async function A(t){const n=await crypto.subtle.exportKey("jwk",t);return JSON.stringify(n)}async function oe(t){return await crypto.subtle.exportKey("raw",t)}async function le(t){const n=JSON.parse(t);return await crypto.subtle.importKey("jwk",n,{name:"ECDH",namedCurve:"P-256"},!0,[])}async function se(t){const n=JSON.parse(t);return await crypto.subtle.importKey("jwk",n,{name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"])}async function ce(t,n){const r=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"]);return await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},r.privateKey,t)}async function ye(t,n){const r=await G(n),a=crypto.getRandomValues(new Uint8Array(12)),l=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},r,Ee(t));return{ciphertext:v(l),iv:v(a)}}async function de(t,n,r){const a=await G(r),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:k(n)},a,k(t));return xe(l)}async function ue(t,n){const r=await se(t),a=await le(n),l=await crypto.subtle.deriveBits({name:"ECDH",public:a},r,256);return v(l)}async function G(t){const n=k(t),r=await crypto.subtle.importKey("raw",n,"HKDF",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:new Uint8Array([]),info:new Uint8Array([])},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function pe(t,n,r){return{rootKey:r,sendingChainKey:null,receivingChainKey:null,sendCounter:0,receiveCounter:0,myRatchetPrivateKey:t,theirRatchetPublicKey:n}}async function me(t,n){if(n==="send"){t.sendCounter++;const r=await D(t.sendingChainKey||t.rootKey);t.sendingChainKey=r}else{t.receiveCounter++;const r=await D(t.receivingChainKey||t.rootKey);t.receivingChainKey=r}return t}async function fe(t,n){const r=t+n,a=await D(r);return ve(a).split("").map(f=>parseInt(f,16).toString()).join("").substring(0,60).match(/.{1,5}/g).join(" ")}async function ge(t){const n=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),r=await t.arrayBuffer(),a=crypto.getRandomValues(new Uint8Array(12)),l=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},n,r),y=await crypto.subtle.exportKey("jwk",n);return{encryptedFile:new Blob([l],{type:"application/octet-stream"}),fileKey:JSON.stringify(y),iv:v(a),originalFilename:t.name,originalMimeType:t.type}}async function be(t,n,r,a,l){const y=JSON.parse(n),f=await crypto.subtle.importKey("jwk",y,{name:"AES-GCM",length:256},!1,["decrypt"]),p=await t.arrayBuffer(),g=await crypto.subtle.decrypt({name:"AES-GCM",iv:k(r)},f,p);return new File([g],a,{type:l})}function Ee(t){return new TextEncoder().encode(t)}function xe(t){return new TextDecoder().decode(t)}function v(t){const n=new Uint8Array(t);let r="";for(let a=0;a<n.byteLength;a++)r+=String.fromCharCode(n[a]);return btoa(r)}function k(t){const n=atob(t),r=new Uint8Array(n.length);for(let a=0;a<n.length;a++)r[a]=n.charCodeAt(a);return r.buffer}function ve(t){const n=new Uint8Array(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("")}async function D(t){const n=new TextEncoder,r=typeof t=="string"?n.encode(t):t;return await crypto.subtle.digest("SHA-256",r)}async function we(t,n,r){try{return localStorage.setItem(`e2ee_identity_private_${t}`,n),localStorage.setItem(`e2ee_signed_pre_key_private_${t}`,r),localStorage.setItem(`e2ee_keys_timestamp_${t}`,Date.now().toString()),console.log("âœ… Private keys stored locally"),!0}catch(a){throw console.error("âŒ Failed to store private keys:",a),a}}async function Ke(t){try{const n=localStorage.getItem(`e2ee_identity_private_${t}`),r=localStorage.getItem(`e2ee_signed_pre_key_private_${t}`),a=localStorage.getItem(`e2ee_keys_timestamp_${t}`);return!n||!r?null:{username:t,identityPrivateKey:n,signedPreKeyPrivateKey:r,timestamp:parseInt(a)}}catch(n){return console.error("âŒ Failed to retrieve private keys:",n),null}}async function Se(t,n,r){try{const a=await r(`${t}/e2ee/pre-key-bundle/${n}/`);if(!a.ok)throw new Error(`Failed to fetch public keys: ${a.status}`);return await a.json()}catch(a){throw console.error("âŒ Failed to fetch user public keys:",a),a}}console.log("âœ… E2EE Crypto Utils loaded");const he=Object.freeze(Object.defineProperty({__proto__:null,decryptFile:be,decryptMessage:de,deriveSharedSecret:ue,encryptFile:ge,encryptMessage:ye,fetchUserPublicKeys:Se,generateIdentityKeyPair:re,generateOneTimePreKeys:ie,generateSafetyNumber:fe,generateSignedPreKeyPair:ae,getPrivateKeys:Ke,initializeRatchet:pe,ratchetForward:me,storePrivateKeys:we},Symbol.toStringTag,{value:"Module"})),ke=({username:t,targetUser:n,apiBaseUrl:r,fetchWithAuth:a,onClose:l})=>{const[y,f]=s.useState(null),[p,g]=s.useState(!1),[x,b]=s.useState(!1),[j,C]=s.useState(!0),[P,w]=s.useState(!1);s.useEffect(()=>{z()},[n]);const z=async()=>{try{const d=await(await a(`${r}/e2ee/safety-number/${n}/`)).json();f(d.safetyNumber),g(d.verified),b(d.verifiedByMe),C(!1)}catch(c){console.error("Failed to fetch safety number:",c),C(!1)}},T=async()=>{try{const d=await(await a(`${r}/e2ee/verify-safety-number/${n}/`,{method:"POST"})).json();b(!0),g(d.bothVerified),m.success(`âœ… Safety number doÄŸrulandÄ±!${d.bothVerified?`

Her iki taraf da doÄŸruladÄ±! ðŸŽ‰`:""}`)}catch(c){console.error("Failed to verify safety number:",c),m.error("âŒ DoÄŸrulama baÅŸarÄ±sÄ±z!")}};return j?e.createElement("div",{style:i.overlay,onClick:l},e.createElement("div",{style:i.modal,onClick:c=>c.stopPropagation()},e.createElement("p",{style:i.loading},"YÃ¼kleniyor..."))):e.createElement("div",{style:i.overlay,onClick:l},e.createElement("div",{style:i.modal,onClick:c=>c.stopPropagation()},e.createElement("div",{style:i.header},e.createElement(O,{size:32,color:p?"#43b581":"#faa61a"}),e.createElement("h2",{style:i.title},"Safety Number"),e.createElement("button",{onClick:l,style:i.closeButton},e.createElement(M,null))),e.createElement("div",{style:i.user},n),P?e.createElement(e.Fragment,null,e.createElement("div",{style:i.qrContainer},e.createElement(ne,{value:y||"",size:200})),e.createElement("button",{onClick:()=>w(!1),style:i.qrButton},"NumarayÄ± GÃ¶ster")):e.createElement(e.Fragment,null,e.createElement("div",{style:i.numberContainer},y?.split(" ").map((c,d)=>e.createElement("div",{key:d,style:i.numberGroup},c))),e.createElement("button",{onClick:()=>w(!0),style:i.qrButton},e.createElement(q,null)," QR Kodu GÃ¶ster")),e.createElement("div",{style:i.statusContainer},p?e.createElement("div",{style:i.statusVerified},e.createElement(I,{size:20}),e.createElement("span",null,"Her iki taraf da doÄŸruladÄ±! âœ…")):x?e.createElement("div",{style:i.statusPartial},e.createElement(I,{size:20}),e.createElement("span",null,"Siz doÄŸruladÄ±nÄ±z. ",n," henÃ¼z doÄŸrulamadÄ±.")):e.createElement("div",{style:i.statusUnverified},e.createElement(M,{size:20}),e.createElement("span",null,"HenÃ¼z doÄŸrulanmadÄ±"))),e.createElement("div",{style:i.info},e.createElement("h3",null,"Safety Number Nedir?"),e.createElement("p",null,"Safety number, sizin ve ",n,"'in ÅŸifreleme anahtarlarÄ±nÄ±n parmak izidir (fingerprint). Bu numarayÄ± karÅŸÄ±laÅŸtÄ±rarak identity key'lerini doÄŸrulayabilirsiniz."),e.createElement("h3",null,"NasÄ±l DoÄŸrulanÄ±r?"),e.createElement("ol",null,e.createElement("li",null,n," ile yÃ¼z yÃ¼ze gÃ¶rÃ¼ÅŸÃ¼n veya gÃ¼venilir bir kanal kullanÄ±n"),e.createElement("li",null,"Her ikiniz de safety number'Ä± aÃ§Ä±n"),e.createElement("li",null,"NumaralarÄ± karÅŸÄ±laÅŸtÄ±rÄ±n (aynÄ± olmalÄ±!)"),e.createElement("li",null,'EÅŸleÅŸiyorsa "DoÄŸrula" butonuna basÄ±n'))),!x&&e.createElement("button",{onClick:T,style:i.verifyButton},e.createElement(I,null)," Bu NumarayÄ± DoÄŸrula")))},i={overlay:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e5},modal:{backgroundColor:"#2b2d31",borderRadius:"8px",padding:"24px",maxWidth:"500px",width:"90%",maxHeight:"90vh",overflowY:"auto"},header:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"24px",position:"relative"},title:{color:"#fff",fontSize:"20px",fontWeight:"600",flex:1},closeButton:{backgroundColor:"transparent",border:"none",color:"#b9bbbe",cursor:"pointer",padding:"4px",fontSize:"20px"},user:{color:"#5865f2",fontSize:"18px",fontWeight:"500",marginBottom:"24px",textAlign:"center"},numberContainer:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"12px",marginBottom:"24px"},numberGroup:{backgroundColor:"#1e1f22",color:"#fff",padding:"12px",borderRadius:"4px",textAlign:"center",fontSize:"18px",fontFamily:"monospace",letterSpacing:"2px"},qrContainer:{display:"flex",justifyContent:"center",marginBottom:"24px",padding:"16px",backgroundColor:"#fff",borderRadius:"8px"},qrButton:{backgroundColor:"#4e5058",color:"#fff",border:"none",borderRadius:"4px",padding:"10px 16px",fontSize:"14px",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px",margin:"0 auto 24px"},statusContainer:{marginBottom:"24px"},statusVerified:{backgroundColor:"#43b581",color:"#fff",padding:"12px",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px",justifyContent:"center"},statusPartial:{backgroundColor:"#faa61a",color:"#000",padding:"12px",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px",justifyContent:"center"},statusUnverified:{backgroundColor:"#ed4245",color:"#fff",padding:"12px",borderRadius:"4px",display:"flex",alignItems:"center",gap:"8px",justifyContent:"center"},info:{backgroundColor:"#1e1f22",padding:"16px",borderRadius:"8px",marginBottom:"24px",color:"#b9bbbe",fontSize:"14px"},verifyButton:{backgroundColor:"#43b581",color:"#fff",border:"none",borderRadius:"4px",padding:"12px 24px",fontSize:"16px",fontWeight:"500",cursor:"pointer",width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},loading:{color:"#b9bbbe",textAlign:"center",padding:"32px"}},Ie=({username:t,apiBaseUrl:n,fetchWithAuth:r})=>{const[a,l]=s.useState(!1),[y,f]=s.useState(null),[p,g]=s.useState(null),[x,b]=s.useState(!1),[j,C]=s.useState({encryptedMessagesCount:0,trustedContacts:0,lastKeyRotation:null}),[P,w]=s.useState(!1),[z,T]=s.useState(null);s.useEffect(()=>{c()},[]);const c=()=>{const u=localStorage.getItem("e2ee_enabled")==="true",K=localStorage.getItem("e2ee_setup_date"),S=localStorage.getItem("e2ee_last_rotation");l(u),f(K?new Date(K):null),g(S?new Date(S):null)},d=async()=>{if(window.confirm(`ðŸ”‘ AnahtarlarÄ± yenilemek istediÄŸinizden emin misiniz?

Bu iÅŸlem:
â€¢ Yeni kimlik anahtarlarÄ± oluÅŸturur
â€¢ Eski ÅŸifreli mesajlar okunamaz hale gelir
â€¢ TÃ¼m kiÅŸilerle yeniden gÃ¼venlik doÄŸrulamasÄ± gerekir`)){b(!0);try{const{generateIdentityKeyPair:u,generateSignedPreKeyPair:K,generateOneTimePreKeys:S,storePrivateKeys:J}=await te(async()=>{const{generateIdentityKeyPair:E,generateSignedPreKeyPair:Q,generateOneTimePreKeys:U,storePrivateKeys:W}=await Promise.resolve().then(()=>he);return{generateIdentityKeyPair:E,generateSignedPreKeyPair:Q,generateOneTimePreKeys:U,storePrivateKeys:W}},void 0,import.meta.url);m.info("ðŸ” Yeni anahtarlar oluÅŸturuluyor...");const B=await u(),h=await K(Date.now(),B.privateKey),Y=await S(100);if(await J(t,B.privateKey,h.privateKey),m.info("â˜ï¸ Sunucuya yÃ¼kleniyor..."),(await r(`${n}/e2ee/rotate-keys/`,{method:"POST",body:JSON.stringify({identityPublicKey:B.publicKey,signedPreKeyId:h.keyId,signedPreKeyPublic:h.publicKey,signedPreKeySignature:h.signature,oneTimePreKeys:Y.map(E=>({keyId:E.keyId,publicKey:E.publicKey}))})})).ok){const E=new Date().toISOString();localStorage.setItem("e2ee_last_rotation",E),g(new Date(E)),m.success("âœ… Anahtarlar baÅŸarÄ±yla yenilendi!")}else throw new Error("Key rotation failed")}catch(u){console.error("Key rotation error:",u),m.error("âŒ Anahtar yenileme baÅŸarÄ±sÄ±z!")}finally{b(!1)}}},V=async()=>{if(window.confirm(`âš ï¸ E2EE'yi devre dÄ±ÅŸÄ± bÄ±rakmak istediÄŸinizden emin misiniz?

Bu iÅŸlem:
â€¢ TÃ¼m ÅŸifreli mesajlarÄ±nÄ±zÄ± siler
â€¢ AnahtarlarÄ±nÄ±zÄ± kaldÄ±rÄ±r
â€¢ Geri alÄ±namaz!`)){b(!0);try{localStorage.removeItem("e2ee_enabled"),localStorage.removeItem("e2ee_setup_date"),localStorage.removeItem("e2ee_last_rotation"),localStorage.removeItem(`e2ee_identity_private_${t}`),localStorage.removeItem(`e2ee_signed_pre_key_private_${t}`),l(!1),m.success("âœ… E2EE devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±")}catch(u){console.error("E2EE disable error:",u),m.error("âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z!")}finally{b(!1)}}},F=u=>u?u.toLocaleDateString("tr-TR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"HiÃ§",_=p?Math.floor((new Date-p)/(1e3*60*60*24)):y?Math.floor((new Date-y)/(1e3*60*60*24)):null,L=_&&_>90;return a?e.createElement("div",{style:o.container},e.createElement("div",{style:o.header},e.createElement(H,{size:24}),e.createElement("h3",{style:o.title},"E2EE AyarlarÄ±")),e.createElement("div",{style:o.statusCard},e.createElement("div",{style:o.statusHeader},e.createElement(X,{size:32,color:"#43b581"}),e.createElement("span",{style:o.statusText},"E2EE Aktif")),e.createElement("div",{style:o.statusInfo},e.createElement("div",{style:o.infoRow},e.createElement(Z,null),e.createElement("span",null,"Kurulum: ",F(y))),p&&e.createElement("div",{style:o.infoRow},e.createElement($,null),e.createElement("span",null,"Son Yenileme: ",F(p))))),L&&e.createElement("div",{style:o.warningCard},e.createElement(N,null),e.createElement("div",null,e.createElement("strong",null,"Anahtar Yenileme Ã–nerilir"),e.createElement("p",null,"Son anahtar yenilemeden ",_," gÃ¼n geÃ§ti. GÃ¼venlik iÃ§in anahtarlarÄ±nÄ±zÄ± yenileyin."))),e.createElement("div",{style:o.actions},e.createElement("button",{onClick:d,disabled:x,style:o.rotateButton},e.createElement($,null),x?"Yenileniyor...":"AnahtarlarÄ± Yenile"),e.createElement("button",{onClick:V,disabled:x,style:o.disableButton},e.createElement(ee,null),"E2EE\\'yi Devre DÄ±ÅŸÄ± BÄ±rak")),e.createElement("div",{style:o.infoSection},e.createElement("h4",{style:o.infoTitle},e.createElement(O,null),"E2EE HakkÄ±nda"),e.createElement("ul",{style:o.infoList},e.createElement("li",null,"âœ… MesajlarÄ±nÄ±z uÃ§tan uca ÅŸifrelenir"),e.createElement("li",null,"âœ… Sadece siz ve karÅŸÄ±nÄ±zdaki kiÅŸi okuyabilir"),e.createElement("li",null,"âœ… Sunucu bile mesajlarÄ± gÃ¶remez"),e.createElement("li",null,"âš ï¸ AnahtarlarÄ±nÄ±zÄ± kaybederseniz mesajlar okunamaz"),e.createElement("li",null,"ðŸ”‘ 90 gÃ¼nde bir anahtar yenileme Ã¶nerilir"))),P&&e.createElement(ke,{username:t,targetUser:z,apiBaseUrl:n,fetchWithAuth:r,onClose:()=>w(!1)})):e.createElement("div",{style:o.container},e.createElement("div",{style:o.header},e.createElement(H,{size:24}),e.createElement("h3",{style:o.title},"End-to-End Encryption")),e.createElement("div",{style:o.disabledState},e.createElement(N,{size:48,color:"#faa61a"}),e.createElement("h4",null,"E2EE Devre DÄ±ÅŸÄ±"),e.createElement("p",null,"Åžu anda E2EE kullanmÄ±yorsunuz. MesajlarÄ±nÄ±zÄ± ÅŸifrelemek iÃ§in ayarlardan etkinleÅŸtirin.")))},o={container:{padding:"20px",backgroundColor:"#2f3136",borderRadius:"8px",color:"#dcddde"},header:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"24px",paddingBottom:"16px",borderBottom:"2px solid #40444b"},title:{margin:0,fontSize:"20px",fontWeight:"bold"},statusCard:{backgroundColor:"#202225",borderRadius:"8px",padding:"20px",marginBottom:"16px",border:"2px solid #43b581"},statusHeader:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"16px"},statusText:{fontSize:"18px",fontWeight:"bold",color:"#43b581"},statusInfo:{display:"flex",flexDirection:"column",gap:"8px"},infoRow:{display:"flex",alignItems:"center",gap:"8px",fontSize:"14px",color:"#b9bbbe"},warningCard:{backgroundColor:"#faa61a20",border:"2px solid #faa61a",borderRadius:"8px",padding:"16px",marginBottom:"16px",display:"flex",gap:"12px",alignItems:"flex-start",color:"#faa61a"},actions:{display:"flex",flexDirection:"column",gap:"12px",marginBottom:"24px"},rotateButton:{padding:"12px 20px",backgroundColor:"#5865f2",color:"white",border:"none",borderRadius:"6px",fontSize:"14px",fontWeight:"600",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",transition:"background-color 0.2s"},disableButton:{padding:"12px 20px",backgroundColor:"#ed4245",color:"white",border:"none",borderRadius:"6px",fontSize:"14px",fontWeight:"600",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",transition:"background-color 0.2s"},disabledState:{textAlign:"center",padding:"40px 20px",color:"#b9bbbe"},infoSection:{backgroundColor:"#202225",borderRadius:"8px",padding:"20px"},infoTitle:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"12px",fontSize:"16px"},infoList:{margin:0,paddingLeft:"20px",color:"#b9bbbe",fontSize:"14px",lineHeight:"1.8"}};export{Ie as default};
