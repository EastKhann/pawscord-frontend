import{r as a,n as t}from"./react-core-zXIKm1Jm.js";import{aa as le,t as ie,a as ue,aV as de,aW as he,a$ as me,J as ye,ck as pe,c9 as fe}from"./icons-vendor-BBdoVeJd.js";import{W as xe,n as je,t as u,A as I}from"./index-DzDUXmXs.js";import"./editor-vendor-DiU449Dh.js";import"./media-vendor-BSOZ7IB3.js";import"./router-vendor-PJALNo1v.js";import"./crypto-vendor-D_AcF0lD.js";import"./state-vendor-8NbFPBhQ.js";const Ce=({roomId:f,onClose:d})=>{const[c,x]=a.useState(null),[k,S]=a.useState(!1),[M,y]=a.useState(!1),[j,$]=a.useState(""),[E,_]=a.useState([]),[V,A]=a.useState([]),[b,P]=a.useState(""),[o,J]=a.useState(!1),[h,v]=a.useState(!1),[l,C]=a.useState(0),[g,L]=a.useState(!1),[U,W]=a.useState(!1),[O,z]=a.useState(!0),[B,R]=a.useState([]),n=a.useRef(null),i=a.useRef(null),w=a.useRef(null),T=a.useRef(null),N=a.useRef(null),p=localStorage.getItem("access_token"),D=a.useCallback(e=>{n.current&&n.current.close();const s=`${xe}://${je}/ws/watch-party/${e}/?token=${p}`,r=new WebSocket(s);r.onopen=()=>{console.log("ðŸ“º Watch Party WebSocket connected"),r.send(JSON.stringify({type:"request_sync"}))},r.onmessage=m=>{const oe=JSON.parse(m.data);H(oe)},r.onclose=()=>{console.log("ðŸ“º Watch Party WebSocket disconnected")},r.onerror=m=>{console.error("ðŸ“º Watch Party WebSocket error:",m)},n.current=r,N.current=setInterval(()=>{r.readyState===WebSocket.OPEN&&r.send(JSON.stringify({type:"heartbeat",local_time:l,is_buffering:!1}))},5e3)},[p,l]),H=e=>{switch(e.type){case"sync_playback":Y(e);break;case"reaction":q(e);break;case"chat_message":G(e);break;case"viewer_joined":K(e);break;case"viewer_left":Z(e);break;case"party_ended":Q();break;case"video_changed":X(e);break}},Y=e=>{(e.by_user==="system"||!o)&&(C(e.current_time),v(e.status==="playing"),i.current&&(i.current.seekTo(e.current_time),e.status==="playing"?i.current.play():i.current.pause()))},q=e=>{const s=Date.now()+Math.random();R(r=>[...r,{...e,id:s}]),setTimeout(()=>{R(r=>r.filter(m=>m.id!==s))},3e3)},G=e=>{A(s=>[...s,e]),setTimeout(()=>{T.current?.scrollIntoView({behavior:"smooth"})},100)},K=e=>{u.success(`${e.username} katÄ±ldÄ±!`),_(s=>s.find(r=>r.username===e.username)?s:[...s,{username:e.username,id:e.user_id}])},Z=e=>{_(s=>s.filter(r=>r.username!==e.username))},Q=e=>{u.info("Watch Party sona erdi"),x(null),d?.()},X=e=>{x(s=>({...s,video_url:e.video_url,video_title:e.video_title,embed_url:e.embed_url})),C(0),v(!1)},ee=async()=>{if(!j.trim()){u.error("Video URL gerekli");return}S(!0);try{const e=await fetch(`${I}/rooms/${f}/watch-party/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`},body:JSON.stringify({video_url:j,allow_control:!1})});if(e.ok){const s=await e.json();x(s),J(!0),y(!1),D(s.id),u.success("Watch Party oluÅŸturuldu! ðŸŽ‰")}else{const s=await e.json();u.error(s.error||"Watch Party oluÅŸturulamadÄ±")}}catch(e){console.error("Watch Party create error:",e),u.error("BaÄŸlantÄ± hatasÄ±")}finally{S(!1)}},te=e=>{!o||!n.current||n.current.send(JSON.stringify({type:"sync",action:e,current_time:l,playback_rate:1}))},se=e=>{n.current&&n.current.send(JSON.stringify({type:"reaction",emoji:e,video_time:l}))},F=()=>{!b.trim()||!n.current||(n.current.send(JSON.stringify({type:"message",content:b,video_time:l})),P(""))},ae=async()=>{if(!(!c||!o))try{await fetch(`${I}/watch-party/${c.id}/end/`,{method:"POST",headers:{Authorization:`Bearer ${p}`}})}catch(e){console.error("End party error:",e)}},re=()=>{o&&te(h?"pause":"play"),v(!h)},ne=()=>{w.current&&(document.fullscreenElement?(document.exitFullscreen(),W(!1)):(w.current.requestFullscreen(),W(!0)))};a.useEffect(()=>()=>{n.current&&n.current.close(),N.current&&clearInterval(N.current)},[]);const ce=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ”¥","ðŸ‘","ðŸŽ‰"];return c?t.jsxs("div",{className:"watch-together-container",ref:w,children:[t.jsxs("div",{className:"watch-header",children:[t.jsxs("div",{className:"watch-title",children:[t.jsx("span",{className:"live-badge",children:"CANLI"}),t.jsx("h3",{children:c.video_title||"Watch Party"})]}),t.jsxs("div",{className:"watch-viewers",children:[t.jsx(ie,{}),t.jsxs("span",{children:[E.length," izleyici"]})]}),t.jsx("button",{className:"close-btn",onClick:d,children:t.jsx(ue,{})})]}),t.jsxs("div",{className:"watch-player",children:[c.video_source==="youtube"&&t.jsx("iframe",{ref:i,src:`https://www.youtube.com/embed/${be(c.video_url)}?autoplay=${h?1:0}&start=${Math.floor(l)}&enablejsapi=1`,title:"Watch Party",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),c.video_source==="direct"&&t.jsx("video",{ref:i,src:c.video_url,autoPlay:h,muted:g}),t.jsx("div",{className:"reaction-overlay",children:B.map(e=>t.jsx("div",{className:"floating-reaction",style:{left:`${Math.random()*80+10}%`},children:e.emoji},e.id))})]}),t.jsxs("div",{className:"watch-controls",children:[t.jsxs("div",{className:"control-left",children:[o&&t.jsx("button",{onClick:re,children:h?t.jsx(de,{}):t.jsx(he,{})}),t.jsx("button",{onClick:()=>L(!g),children:g?t.jsx(me,{}):t.jsx(ye,{})})]}),t.jsx("div",{className:"reactions-bar",children:ce.map(e=>t.jsx("button",{className:"reaction-btn",onClick:()=>se(e),children:e},e))}),t.jsxs("div",{className:"control-right",children:[t.jsx("button",{onClick:()=>z(!O),children:"ðŸ’¬"}),t.jsx("button",{onClick:ne,children:U?t.jsx(pe,{}):t.jsx(fe,{})}),o&&t.jsx("button",{className:"end-btn",onClick:ae,children:"Bitir"})]})]}),O&&t.jsxs("div",{className:"watch-chat",children:[t.jsxs("div",{className:"chat-messages",children:[V.map((e,s)=>t.jsxs("div",{className:"chat-message",children:[t.jsx("img",{src:e.avatar||"/default-avatar.png",alt:e.user,className:"chat-avatar"}),t.jsxs("div",{className:"chat-content",children:[t.jsx("span",{className:"chat-user",children:e.user}),t.jsx("span",{className:"chat-text",children:e.content})]})]},s)),t.jsx("div",{ref:T})]}),t.jsxs("div",{className:"chat-input",children:[t.jsx("input",{type:"text",placeholder:"Mesaj yaz...",value:b,onChange:e=>P(e.target.value),onKeyPress:e=>e.key==="Enter"&&F()}),t.jsx("button",{onClick:F,children:"GÃ¶nder"})]})]})]}):t.jsxs("div",{className:"watch-together-container",children:[t.jsxs("div",{className:"watch-together-empty",children:[t.jsx("h2",{children:"ðŸ“º Watch Together"}),t.jsx("p",{children:"ArkadaÅŸlarÄ±nla birlikte video izle!"}),t.jsxs("button",{className:"create-party-btn",onClick:()=>y(!0),children:[t.jsx(le,{})," Yeni Watch Party OluÅŸtur"]}),t.jsxs("div",{className:"supported-platforms",children:[t.jsx("span",{children:"Desteklenen platformlar:"}),t.jsxs("div",{className:"platforms",children:[t.jsx("span",{children:"YouTube"}),t.jsx("span",{children:"Twitch"}),t.jsx("span",{children:"Vimeo"}),t.jsx("span",{children:"Dailymotion"})]})]})]}),M&&t.jsx("div",{className:"watch-modal-overlay",onClick:()=>y(!1),children:t.jsxs("div",{className:"watch-modal",onClick:e=>e.stopPropagation(),children:[t.jsx("h3",{children:"ðŸŽ¬ Watch Party OluÅŸtur"}),t.jsx("input",{type:"url",placeholder:"Video URL'sini yapÄ±ÅŸtÄ±r...",value:j,onChange:e=>$(e.target.value),autoFocus:!0}),t.jsxs("div",{className:"modal-actions",children:[t.jsx("button",{className:"cancel-btn",onClick:()=>y(!1),children:"Ä°ptal"}),t.jsx("button",{className:"create-btn",onClick:ee,disabled:k,children:k?"OluÅŸturuluyor...":"OluÅŸtur"})]})]})})]})},be=f=>{const d=f.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return d?d[1]:""};export{Ce as default};
