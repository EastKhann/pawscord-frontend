import{r,d as t,aC as oe,G as ie,i as ue,bJ as me,bK as de,bQ as he,$ as ye,de as fe,d0 as pe}from"./react-core-DrOm_csO.js";import{W as Ee,o as be,t as u,A as M}from"./index-BYhWpPLp.js";const ke=({roomId:p,onClose:m})=>{const[c,E]=r.useState(null),[S,_]=r.useState(!1),[$,y]=r.useState(!1),[b,V]=r.useState(""),[A,P]=r.useState([]),[J,L]=r.useState([]),[v,C]=r.useState(""),[l,U]=r.useState(!1),[d,g]=r.useState(!1),[o,W]=r.useState(0),[w,x]=r.useState(!1),[z,O]=r.useState(!1),[R,B]=r.useState(!0),[j,T]=r.useState([]),s=r.useRef(null),i=r.useRef(null),k=r.useRef(null),F=r.useRef(null),N=r.useRef(null),f=localStorage.getItem("access_token"),D=r.useCallback(e=>{s.current&&s.current.close();const a=`${Ee}://${be}/ws/watch-party/${e}/?token=${f}`,n=new WebSocket(a);n.onopen=()=>{console.log("ðŸ“º Watch Party WebSocket connected"),n.send(JSON.stringify({type:"request_sync"}))},n.onmessage=h=>{const le=JSON.parse(h.data);H(le)},n.onclose=()=>{console.log("ðŸ“º Watch Party WebSocket disconnected")},n.onerror=h=>{console.error("ðŸ“º Watch Party WebSocket error:",h)},s.current=n,N.current=setInterval(()=>{n.readyState===WebSocket.OPEN&&n.send(JSON.stringify({type:"heartbeat",local_time:o,is_buffering:!1}))},5e3)},[f,o]),H=e=>{switch(e.type){case"sync_playback":Y(e);break;case"reaction":q(e);break;case"chat_message":G(e);break;case"viewer_joined":K(e);break;case"viewer_left":Q(e);break;case"party_ended":Z();break;case"video_changed":X(e);break}},Y=e=>{(e.by_user==="system"||!l)&&(W(e.current_time),g(e.status==="playing"),i.current&&(i.current.seekTo(e.current_time),e.status==="playing"?i.current.play():i.current.pause()))},q=e=>{const a=Date.now()+Math.random();T(n=>[...n,{...e,id:a}]),setTimeout(()=>{T(n=>n.filter(h=>h.id!==a))},3e3)},G=e=>{L(a=>[...a,e]),setTimeout(()=>{F.current?.scrollIntoView({behavior:"smooth"})},100)},K=e=>{u.success(`${e.username} katÄ±ldÄ±!`),P(a=>a.find(n=>n.username===e.username)?a:[...a,{username:e.username,id:e.user_id}])},Q=e=>{P(a=>a.filter(n=>n.username!==e.username))},Z=e=>{u.info("Watch Party sona erdi"),E(null),m?.()},X=e=>{E(a=>({...a,video_url:e.video_url,video_title:e.video_title,embed_url:e.embed_url})),W(0),g(!1)},ee=async()=>{if(!b.trim()){u.error("Video URL gerekli");return}_(!0);try{const e=await fetch(`${M}/rooms/${p}/watch-party/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`},body:JSON.stringify({video_url:b,allow_control:!1})});if(e.ok){const a=await e.json();E(a),U(!0),y(!1),D(a.id),u.success("Watch Party oluÅŸturuldu! ðŸŽ‰")}else{const a=await e.json();u.error(a.error||"Watch Party oluÅŸturulamadÄ±")}}catch(e){console.error("Watch Party create error:",e),u.error("BaÄŸlantÄ± hatasÄ±")}finally{_(!1)}},te=e=>{!l||!s.current||s.current.send(JSON.stringify({type:"sync",action:e,current_time:o,playback_rate:1}))},ae=e=>{s.current&&s.current.send(JSON.stringify({type:"reaction",emoji:e,video_time:o}))},I=()=>{!v.trim()||!s.current||(s.current.send(JSON.stringify({type:"message",content:v,video_time:o})),C(""))},re=async()=>{if(!(!c||!l))try{await fetch(`${M}/watch-party/${c.id}/end/`,{method:"POST",headers:{Authorization:`Bearer ${f}`}})}catch(e){console.error("End party error:",e)}},ne=()=>{l&&te(d?"pause":"play"),g(!d)},se=()=>{k.current&&(document.fullscreenElement?(document.exitFullscreen(),O(!1)):(k.current.requestFullscreen(),O(!0)))};r.useEffect(()=>()=>{s.current&&s.current.close(),N.current&&clearInterval(N.current)},[]);const ce=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ”¥","ðŸ‘","ðŸŽ‰"];return c?t.createElement("div",{className:"watch-together-container",ref:k},t.createElement("div",{className:"watch-header"},t.createElement("div",{className:"watch-title"},t.createElement("span",{className:"live-badge"},"CANLI"),t.createElement("h3",null,c.video_title||"Watch Party")),t.createElement("div",{className:"watch-viewers"},t.createElement(ie,null),t.createElement("span",null,A.length," izleyici")),t.createElement("button",{className:"close-btn",onClick:m},t.createElement(ue,null))),t.createElement("div",{className:"watch-player"},c.video_source==="youtube"&&t.createElement("iframe",{ref:i,src:`https://www.youtube.com/embed/${ve(c.video_url)}?autoplay=${d?1:0}&start=${Math.floor(o)}&enablejsapi=1`,title:"Watch Party",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),c.video_source==="direct"&&t.createElement("video",{ref:i,src:c.video_url,autoPlay:d,muted:w}),t.createElement("div",{className:"reaction-overlay"},j.map(e=>t.createElement("div",{key:e.id,className:"floating-reaction",style:{left:`${Math.random()*80+10}%`}},e.emoji)))),t.createElement("div",{className:"watch-controls"},t.createElement("div",{className:"control-left"},l&&t.createElement("button",{onClick:ne},d?t.createElement(me,null):t.createElement(de,null)),t.createElement("button",{onClick:()=>x(!w)},w?t.createElement(he,null):t.createElement(ye,null))),t.createElement("div",{className:"reactions-bar"},ce.map(e=>t.createElement("button",{key:e,className:"reaction-btn",onClick:()=>ae(e)},e))),t.createElement("div",{className:"control-right"},t.createElement("button",{onClick:()=>B(!R)},"ðŸ’¬"),t.createElement("button",{onClick:se},z?t.createElement(fe,null):t.createElement(pe,null)),l&&t.createElement("button",{className:"end-btn",onClick:re},"Bitir"))),R&&t.createElement("div",{className:"watch-chat"},t.createElement("div",{className:"chat-messages"},J.map((e,a)=>t.createElement("div",{key:a,className:"chat-message"},t.createElement("img",{src:e.avatar||"/default-avatar.png",alt:e.user,className:"chat-avatar"}),t.createElement("div",{className:"chat-content"},t.createElement("span",{className:"chat-user"},e.user),t.createElement("span",{className:"chat-text"},e.content)))),t.createElement("div",{ref:F})),t.createElement("div",{className:"chat-input"},t.createElement("input",{type:"text",placeholder:"Mesaj yaz...",value:v,onChange:e=>C(e.target.value),onKeyPress:e=>e.key==="Enter"&&I()}),t.createElement("button",{onClick:I},"GÃ¶nder")))):t.createElement("div",{className:"watch-together-container"},t.createElement("div",{className:"watch-together-empty"},t.createElement("h2",null,"ðŸ“º Watch Together"),t.createElement("p",null,"ArkadaÅŸlarÄ±nla birlikte video izle!"),t.createElement("button",{className:"create-party-btn",onClick:()=>y(!0)},t.createElement(oe,null)," Yeni Watch Party OluÅŸtur"),t.createElement("div",{className:"supported-platforms"},t.createElement("span",null,"Desteklenen platformlar:"),t.createElement("div",{className:"platforms"},t.createElement("span",null,"YouTube"),t.createElement("span",null,"Twitch"),t.createElement("span",null,"Vimeo"),t.createElement("span",null,"Dailymotion")))),$&&t.createElement("div",{className:"watch-modal-overlay",onClick:()=>y(!1)},t.createElement("div",{className:"watch-modal",onClick:e=>e.stopPropagation()},t.createElement("h3",null,"ðŸŽ¬ Watch Party OluÅŸtur"),t.createElement("input",{type:"url",placeholder:"Video URL'sini yapÄ±ÅŸtÄ±r...",value:b,onChange:e=>V(e.target.value),autoFocus:!0}),t.createElement("div",{className:"modal-actions"},t.createElement("button",{className:"cancel-btn",onClick:()=>y(!1)},"Ä°ptal"),t.createElement("button",{className:"create-btn",onClick:ee,disabled:S},S?"OluÅŸturuluyor...":"OluÅŸtur")))))},ve=p=>{const m=p.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return m?m[1]:""};export{ke as default};
