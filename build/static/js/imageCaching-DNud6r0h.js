import{b as m}from"./react-core-DFLfBPkm.js";import"./chart-vendor-CPuFblPm.js";import"./editor-vendor-DiU449Dh.js";const p="pawscord-image-cache",w="v1",C=50*1024*1024,u=10080*60*1e3,r=new Map,g=new Map;class A{constructor(){this.cache=new Map,this.loadFromLocalStorage()}loadFromLocalStorage(){try{const e=localStorage.getItem(`${p}-${w}`);if(e){const a=JSON.parse(e);Object.entries(a).forEach(([t,c])=>{this.isValidCacheEntry(c)&&this.cache.set(t,c)})}}catch(e){console.warn("[ImageCache] Failed to load from localStorage:",e),this.clearCache()}}saveToLocalStorage(){try{const e=Object.fromEntries(this.cache);localStorage.setItem(`${p}-${w}`,JSON.stringify(e))}catch{console.warn("[ImageCache] localStorage full, clearing old entries"),this.pruneCache()}}isValidCacheEntry(e){return!e||!e.timestamp?!1:Date.now()-e.timestamp<u}async get(e){const a=this.cache.get(e);return a&&this.isValidCacheEntry(a)?(a.lastAccessed=Date.now(),this.saveToLocalStorage(),a.data):(a&&this.cache.delete(e),null)}async set(e,a){const t=this.getCacheSize(),c=new Blob([a]).size;t+c>C&&this.pruneCache(),this.cache.set(e,{data:a,timestamp:Date.now(),lastAccessed:Date.now(),size:c}),this.saveToLocalStorage()}getCacheSize(){let e=0;return this.cache.forEach(a=>{e+=a.size||0}),e}pruneCache(){const e=Array.from(this.cache.entries());e.sort((t,c)=>t[1].lastAccessed-c[1].lastAccessed);const a=Math.ceil(e.length*.3);for(let t=0;t<a;t++)this.cache.delete(e[t][0]);this.saveToLocalStorage()}clearCache(){this.cache.clear();try{localStorage.removeItem(`${p}-${w}`)}catch(e){console.warn("[ImageCache] Failed to clear localStorage:",e)}}async prefetch(e){const a=e.map(async t=>{if(!this.cache.has(t))try{const n=await(await fetch(t)).blob(),h=await this.blobToDataUrl(n);await this.set(t,h)}catch(c){console.warn("[ImageCache] Failed to prefetch:",t,c)}});await Promise.allSettled(a)}blobToDataUrl(e){return new Promise((a,t)=>{const c=new FileReader;c.onload=()=>a(c.result),c.onerror=t,c.readAsDataURL(e)})}getStats(){return{entries:this.cache.size,size:this.getCacheSize(),maxSize:C,usage:(this.getCacheSize()/C*100).toFixed(2)+"%",oldestEntry:Math.min(...Array.from(this.cache.values()).map(e=>e.timestamp)),newestEntry:Math.max(...Array.from(this.cache.values()).map(e=>e.timestamp))}}}const i=new A,z=s=>{const[e,a]=m.useState(()=>s&&r.has(s)?r.get(s):null),[t,c]=m.useState(!e),[n,h]=m.useState(null);return m.useEffect(()=>{let l=!1;return(async()=>{if(!s){c(!1);return}if(r.has(s)){a(r.get(s)),c(!1);return}if(g.has(s)){try{const o=await g.get(s);l||(a(o),c(!1))}catch(o){l||(h(o),a(s),c(!1))}return}const f=(async()=>{try{c(!0);const o=await i.get(s);if(o)return r.set(s,o),o;const y=await fetch(s);if(!y.ok)throw new Error("Image fetch failed");const b=await y.blob(),d=await i.blobToDataUrl(b);return await i.set(s,d),r.set(s,d),d}finally{g.delete(s)}})();g.set(s,f);try{const o=await f;l||(a(o),c(!1))}catch(o){l||(h(o),a(s),c(!1))}})(),()=>{l=!0}},[s]),{url:e,loading:t,error:n}},M=async s=>{const a={profile:["/avatars/cat_1.png"],home:["/static/logo.png"]}[s]||[];await i.prefetch(a)},U=()=>{i.clearCache(),r.clear(),g.clear()},L=()=>({...i.getStats(),inMemoryCount:r.size,pendingLoads:g.size}),D=async s=>{if(!s||!Array.isArray(s))return;const e=s.map(t=>t.avatar_url||t.avatar).filter(t=>t&&typeof t=="string"&&t.startsWith("http")).filter(t=>!r.has(t));if(e.length===0)return;console.log(`üñºÔ∏è [AvatarCache] Prefetching ${e.length} avatars...`);const a=5;for(let t=0;t<e.length;t+=a){const c=e.slice(t,t+a);await Promise.allSettled(c.map(async n=>{if(!r.has(n))try{const h=await i.get(n);if(h){r.set(n,h);return}const l=await fetch(n);if(!l.ok)return;const S=await l.blob(),f=await i.blobToDataUrl(S);await i.set(n,f),r.set(n,f)}catch{}}))}console.log(`‚úÖ [AvatarCache] Prefetch complete. Memory cache: ${r.size} items`)},F=s=>s&&r.get(s)||null;export{U as clearImageCache,i as default,F as getAvatarFromCache,L as getImageCacheStats,M as prefetchRouteImages,D as prefetchUserAvatars,z as useCachedImage};
