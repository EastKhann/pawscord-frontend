import{r,n as e}from"./react-core-DA61mcWm.js";import{ac as ce,u as le,a as ie,a_ as oe,a$ as ue,b1 as de,K as he,cq as me,aG as ye}from"./icons-vendor-l2qVv93x.js";import{t as o,W as fe,r as pe,A as x}from"./index-wBOWb2zj.js";import"./ui-vendor-BrUQ4r0A.js";import"./editor-vendor-D9c4a6XZ.js";import"./media-vendor-tDmQW26m.js";import"./router-vendor-2etVlp2q.js";import"./state-vendor-CjqIs3K2.js";import"./crypto-vendor-DiGIAuUm.js";const je=["üëç","‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üî•","üëè","üéâ"],xe=y=>{const u=y.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return u?u[1]:""};function we(y,u){const[t,n]=r.useState(null),[w,p]=r.useState(!1),[B,_]=r.useState(!1),[g,J]=r.useState(""),[U,v]=r.useState([]),[z,H]=r.useState([]),[b,P]=r.useState(""),[d,M]=r.useState(!1),[N,j]=r.useState(!1),[h,S]=r.useState(0),[D,q]=r.useState(!1),[K,R]=r.useState(!1),[Y,G]=r.useState(!0),[Z,$]=r.useState([]),l=r.useRef(null),f=r.useRef(null),k=r.useRef(null),O=r.useRef(null),C=r.useRef(null),m=localStorage.getItem("access_token"),T=r.useCallback(s=>{(s.by_user==="system"||!d)&&(S(s.current_time),j(s.status==="playing"),f.current&&(f.current.seekTo(s.current_time),s.status==="playing"?f.current.play():f.current.pause()))},[d]),W=r.useCallback(s=>{const a=Date.now()+Math.random();$(c=>[...c,{...s,id:a}]),setTimeout(()=>$(c=>c.filter(i=>i.id!==a)),3e3)},[]),F=r.useCallback(s=>{H(a=>[...a,s]),setTimeout(()=>O.current?.scrollIntoView({behavior:"smooth"}),100)},[]),I=r.useCallback(s=>{o.success(`${s.username} katƒ±ldƒ±!`),v(a=>a.find(c=>c.username===s.username)?a:[...a,{username:s.username,id:s.user_id}])},[]),E=r.useCallback(s=>{v(a=>a.filter(c=>c.username!==s.username))},[]),A=r.useCallback(()=>{o.info("Watch Party sona erdi"),n(null),u?.()},[u]),V=r.useCallback(s=>{n(a=>({...a,video_url:s.video_url,video_title:s.video_title,embed_url:s.embed_url})),S(0),j(!1)},[]),L=r.useCallback(s=>{l.current&&l.current.close();const a=new WebSocket(`${fe}://${pe}/ws/watch-party/${s}/?token=${m}`);a.onopen=()=>a.send(JSON.stringify({type:"request_sync"})),a.onmessage=c=>{const i=JSON.parse(c.data);({sync_playback:T,reaction:W,chat_message:F,viewer_joined:I,viewer_left:E,party_ended:A,video_changed:V})[i.type]?.(i)},a.onerror=c=>{},l.current=a,C.current=setInterval(()=>{a.readyState===WebSocket.OPEN&&a.send(JSON.stringify({type:"heartbeat",local_time:h,is_buffering:!1}))},5e3)},[m,h,T,W,F,I,E,A,V]),Q=async()=>{if(!g.trim()){o.error("Video URL gerekli");return}p(!0);try{const s=await fetch(`${x}/rooms/${y}/watch-party/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify({video_url:g,allow_control:!1})});if(s.ok){const a=await s.json();n(a),M(!0),_(!1),L(a.id),o.success("Watch Party olu≈üturuldu! üéâ")}else{const a=await s.json();o.error(a.error||"Watch Party olu≈üturulamadƒ±")}}catch{o.error("Baƒülantƒ± hatasƒ±")}finally{p(!1)}},X=async s=>{p(!0);try{const a=await fetch(`${x}/watch-party/${s}/join/`,{method:"POST",headers:{Authorization:`Bearer ${m}`}});if(a.ok){const i=await(await fetch(`${x}/watch-party/${s}/`,{headers:{Authorization:`Bearer ${m}`}})).json();n(i),M(i.is_host),v(i.viewers||[]),S(i.current_time),j(i.status==="playing"),L(s),o.success("Watch Party'ye katƒ±ldƒ±n! üé¨")}else{const c=await a.json();o.error(c.error||"Katƒ±lƒ±namadƒ±")}}catch{o.error("Baƒülantƒ± hatasƒ±")}finally{p(!1)}},ee=s=>{!d||!l.current||l.current.send(JSON.stringify({type:"sync",action:s,current_time:h,playback_rate:1}))},te=s=>{l.current&&l.current.send(JSON.stringify({type:"reaction",emoji:s,video_time:h}))},se=()=>{!b.trim()||!l.current||(l.current.send(JSON.stringify({type:"message",content:b,video_time:h})),P(""))},ae=async()=>{if(!(!t||!d))try{await fetch(`${x}/watch-party/${t.id}/end/`,{method:"POST",headers:{Authorization:`Bearer ${m}`}})}catch{}},re=()=>{d&&ee(N?"pause":"play"),j(!N)},ne=()=>{k.current&&(document.fullscreenElement?(document.exitFullscreen(),R(!1)):(k.current.requestFullscreen(),R(!0)))};return r.useEffect(()=>()=>{l.current?.close(),C.current&&clearInterval(C.current)},[]),{party:t,isLoading:w,showCreateModal:B,setShowCreateModal:_,videoUrl:g,setVideoUrl:J,viewers:U,messages:z,newMessage:b,setNewMessage:P,isHost:d,isPlaying:N,currentTime:h,isMuted:D,setIsMuted:q,isFullscreen:K,showChat:Y,setShowChat:G,reactions:Z,playerRef:f,containerRef:k,chatEndRef:O,createWatchParty:Q,joinWatchParty:X,sendReaction:te,sendMessage:se,endParty:ae,togglePlay:re,toggleFullscreen:ne}}const Re=({roomId:y,onClose:u})=>{const t=we(y,u);return t.party?e.jsxs("div",{className:"watch-together-container",ref:t.containerRef,children:[e.jsxs("div",{className:"watch-header",children:[e.jsxs("div",{className:"watch-title",children:[e.jsx("span",{className:"live-badge",children:"CANLI"}),e.jsx("h3",{children:t.party.video_title||"Watch Party"})]}),e.jsxs("div",{className:"watch-viewers",children:[e.jsx(le,{}),e.jsxs("span",{children:[t.viewers.length," izleyici"]})]}),e.jsx("button",{className:"close-btn",onClick:u,children:e.jsx(ie,{})})]}),e.jsxs("div",{className:"watch-player",children:[t.party.video_source==="youtube"&&e.jsx("iframe",{ref:t.playerRef,src:`https://www.youtube.com/embed/${xe(t.party.video_url)}?autoplay=${t.isPlaying?1:0}&start=${Math.floor(t.currentTime)}&enablejsapi=1`,title:"Watch Party",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),t.party.video_source==="direct"&&e.jsx("video",{ref:t.playerRef,src:t.party.video_url,autoPlay:t.isPlaying,muted:t.isMuted}),e.jsx("div",{className:"reaction-overlay",children:t.reactions.map(n=>e.jsx("div",{className:"floating-reaction",style:{left:`${Math.random()*80+10}%`},children:n.emoji},n.id))})]}),e.jsxs("div",{className:"watch-controls",children:[e.jsxs("div",{className:"control-left",children:[t.isHost&&e.jsx("button",{onClick:t.togglePlay,children:t.isPlaying?e.jsx(oe,{}):e.jsx(ue,{})}),e.jsx("button",{onClick:()=>t.setIsMuted(!t.isMuted),children:t.isMuted?e.jsx(de,{}):e.jsx(he,{})})]}),e.jsx("div",{className:"reactions-bar",children:je.map(n=>e.jsx("button",{className:"reaction-btn",onClick:()=>t.sendReaction(n),children:n},n))}),e.jsxs("div",{className:"control-right",children:[e.jsx("button",{onClick:()=>t.setShowChat(!t.showChat),children:"üí¨"}),e.jsx("button",{onClick:t.toggleFullscreen,children:t.isFullscreen?e.jsx(me,{}):e.jsx(ye,{})}),t.isHost&&e.jsx("button",{className:"end-btn",onClick:t.endParty,children:"Bitir"})]})]}),t.showChat&&e.jsxs("div",{className:"watch-chat",children:[e.jsxs("div",{className:"chat-messages",children:[t.messages.map((n,w)=>e.jsxs("div",{className:"chat-message",children:[e.jsx("img",{src:n.avatar||"/default-avatar.png",alt:n.user,className:"chat-avatar"}),e.jsxs("div",{className:"chat-content",children:[e.jsx("span",{className:"chat-user",children:n.user}),e.jsx("span",{className:"chat-text",children:n.content})]})]},w)),e.jsx("div",{ref:t.chatEndRef})]}),e.jsxs("div",{className:"chat-input",children:[e.jsx("input",{type:"text",placeholder:"Mesaj yaz...",value:t.newMessage,onChange:n=>t.setNewMessage(n.target.value),onKeyPress:n=>n.key==="Enter"&&t.sendMessage()}),e.jsx("button",{onClick:t.sendMessage,children:"G\\u00f6nder"})]})]})]}):e.jsxs("div",{className:"watch-together-container",children:[e.jsxs("div",{className:"watch-together-empty",children:[e.jsxs("h2",{children:["üì∫"," Watch Together"]}),e.jsx("p",{children:"Arkada\\u015flar\\u0131nla birlikte video izle!"}),e.jsxs("button",{className:"create-party-btn",onClick:()=>t.setShowCreateModal(!0),children:[e.jsx(ce,{})," Yeni Watch Party Olu\\u015ftur"]}),e.jsxs("div",{className:"supported-platforms",children:[e.jsx("span",{children:"Desteklenen platformlar:"}),e.jsxs("div",{className:"platforms",children:[e.jsx("span",{children:"YouTube"}),e.jsx("span",{children:"Twitch"}),e.jsx("span",{children:"Vimeo"}),e.jsx("span",{children:"Dailymotion"})]})]})]}),t.showCreateModal&&e.jsx("div",{className:"watch-modal-overlay",onClick:()=>t.setShowCreateModal(!1),children:e.jsxs("div",{className:"watch-modal",onClick:n=>n.stopPropagation(),children:[e.jsxs("h3",{children:["üé¨"," Watch Party Olu\\u015ftur"]}),e.jsx("input",{type:"url",placeholder:"Video URL'sini yap\\u0131\\u015ft\\u0131r...",value:t.videoUrl,onChange:n=>t.setVideoUrl(n.target.value),autoFocus:!0}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"cancel-btn",onClick:()=>t.setShowCreateModal(!1),children:"\\u0130ptal"}),e.jsx("button",{className:"create-btn",onClick:t.createWatchParty,disabled:t.isLoading,children:t.isLoading?"Olu≈üturuluyor...":"Olu≈ütur"})]})]})})]})};export{Re as default};
