import{r as a,n as s}from"./react-core-BMiyQWF6.js";import{ac as oe,t as ie,a as ue,aW as de,aX as he,b0 as me,J as fe,cn as pe,c9 as ye}from"./icons-vendor-GUGjkvMm.js";import{W as xe,n as je,t as u,A as I}from"./index-CiuOrqQ3.js";import"./editor-vendor-D9c4a6XZ.js";import"./media-vendor-BuSyE8vR.js";import"./router-vendor-B86Z1mIL.js";import"./state-vendor-CAyNnPM4.js";import"./crypto-vendor-1Q6e4ZD-.js";const Pe=({roomId:y,onClose:d})=>{const[c,x]=a.useState(null),[k,S]=a.useState(!1),[M,m]=a.useState(!1),[j,$]=a.useState(""),[E,_]=a.useState([]),[V,A]=a.useState([]),[v,C]=a.useState(""),[l,J]=a.useState(!1),[h,b]=a.useState(!1),[o,P]=a.useState(0),[g,L]=a.useState(!1),[U,O]=a.useState(!1),[R,z]=a.useState(!0),[B,T]=a.useState([]),n=a.useRef(null),i=a.useRef(null),w=a.useRef(null),W=a.useRef(null),N=a.useRef(null),f=localStorage.getItem("access_token"),D=a.useCallback(e=>{n.current&&n.current.close();const t=`${xe}://${je}/ws/watch-party/${e}/?token=${f}`,r=new WebSocket(t);r.onopen=()=>{r.send(JSON.stringify({type:"request_sync"}))},r.onmessage=p=>{const le=JSON.parse(p.data);H(le)},r.onclose=()=>{},r.onerror=p=>{},n.current=r,N.current=setInterval(()=>{r.readyState===WebSocket.OPEN&&r.send(JSON.stringify({type:"heartbeat",local_time:o,is_buffering:!1}))},5e3)},[f,o]),H=e=>{switch(e.type){case"sync_playback":Y(e);break;case"reaction":q(e);break;case"chat_message":G(e);break;case"viewer_joined":K(e);break;case"viewer_left":X(e);break;case"party_ended":Z();break;case"video_changed":Q(e);break}},Y=e=>{(e.by_user==="system"||!l)&&(P(e.current_time),b(e.status==="playing"),i.current&&(i.current.seekTo(e.current_time),e.status==="playing"?i.current.play():i.current.pause()))},q=e=>{const t=Date.now()+Math.random();T(r=>[...r,{...e,id:t}]),setTimeout(()=>{T(r=>r.filter(p=>p.id!==t))},3e3)},G=e=>{A(t=>[...t,e]),setTimeout(()=>{W.current?.scrollIntoView({behavior:"smooth"})},100)},K=e=>{u.success(`${e.username} katÄ±ldÄ±!`),_(t=>t.find(r=>r.username===e.username)?t:[...t,{username:e.username,id:e.user_id}])},X=e=>{_(t=>t.filter(r=>r.username!==e.username))},Z=e=>{u.info("Watch Party sona erdi"),x(null),d?.()},Q=e=>{x(t=>({...t,video_url:e.video_url,video_title:e.video_title,embed_url:e.embed_url})),P(0),b(!1)},ee=async()=>{if(!j.trim()){u.error("Video URL gerekli");return}S(!0);try{const e=await fetch(`${I}/rooms/${y}/watch-party/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`},body:JSON.stringify({video_url:j,allow_control:!1})});if(e.ok){const t=await e.json();x(t),J(!0),m(!1),D(t.id),u.success("Watch Party oluÅŸturuldu! ðŸŽ‰")}else{const t=await e.json();u.error(t.error||"Watch Party oluÅŸturulamadÄ±")}}catch{u.error("BaÄŸlantÄ± hatasÄ±")}finally{S(!1)}},se=e=>{!l||!n.current||n.current.send(JSON.stringify({type:"sync",action:e,current_time:o,playback_rate:1}))},te=e=>{n.current&&n.current.send(JSON.stringify({type:"reaction",emoji:e,video_time:o}))},F=()=>{!v.trim()||!n.current||(n.current.send(JSON.stringify({type:"message",content:v,video_time:o})),C(""))},ae=async()=>{if(!(!c||!l))try{await fetch(`${I}/watch-party/${c.id}/end/`,{method:"POST",headers:{Authorization:`Bearer ${f}`}})}catch{}},re=()=>{l&&se(h?"pause":"play"),b(!h)},ne=()=>{w.current&&(document.fullscreenElement?(document.exitFullscreen(),O(!1)):(w.current.requestFullscreen(),O(!0)))};a.useEffect(()=>()=>{n.current&&n.current.close(),N.current&&clearInterval(N.current)},[]);const ce=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ”¥","ðŸ‘","ðŸŽ‰"];return c?s.jsxs("div",{className:"watch-together-container",ref:w,children:[s.jsxs("div",{className:"watch-header",children:[s.jsxs("div",{className:"watch-title",children:[s.jsx("span",{className:"live-badge",children:"CANLI"}),s.jsx("h3",{children:c.video_title||"Watch Party"})]}),s.jsxs("div",{className:"watch-viewers",children:[s.jsx(ie,{}),s.jsxs("span",{children:[E.length," izleyici"]})]}),s.jsx("button",{className:"close-btn",onClick:d,children:s.jsx(ue,{})})]}),s.jsxs("div",{className:"watch-player",children:[c.video_source==="youtube"&&s.jsx("iframe",{ref:i,src:`https://www.youtube.com/embed/${ve(c.video_url)}?autoplay=${h?1:0}&start=${Math.floor(o)}&enablejsapi=1`,title:"Watch Party",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),c.video_source==="direct"&&s.jsx("video",{ref:i,src:c.video_url,autoPlay:h,muted:g}),s.jsx("div",{className:"reaction-overlay",children:B.map(e=>s.jsx("div",{className:"floating-reaction",style:{left:`${Math.random()*80+10}%`},children:e.emoji},e.id))})]}),s.jsxs("div",{className:"watch-controls",children:[s.jsxs("div",{className:"control-left",children:[l&&s.jsx("button",{onClick:re,children:h?s.jsx(de,{}):s.jsx(he,{})}),s.jsx("button",{onClick:()=>L(!g),children:g?s.jsx(me,{}):s.jsx(fe,{})})]}),s.jsx("div",{className:"reactions-bar",children:ce.map(e=>s.jsx("button",{className:"reaction-btn",onClick:()=>te(e),children:e},e))}),s.jsxs("div",{className:"control-right",children:[s.jsx("button",{onClick:()=>z(!R),children:"ðŸ’¬"}),s.jsx("button",{onClick:ne,children:U?s.jsx(pe,{}):s.jsx(ye,{})}),l&&s.jsx("button",{className:"end-btn",onClick:ae,children:"Bitir"})]})]}),R&&s.jsxs("div",{className:"watch-chat",children:[s.jsxs("div",{className:"chat-messages",children:[V.map((e,t)=>s.jsxs("div",{className:"chat-message",children:[s.jsx("img",{src:e.avatar||"/default-avatar.png",alt:e.user,className:"chat-avatar"}),s.jsxs("div",{className:"chat-content",children:[s.jsx("span",{className:"chat-user",children:e.user}),s.jsx("span",{className:"chat-text",children:e.content})]})]},t)),s.jsx("div",{ref:W})]}),s.jsxs("div",{className:"chat-input",children:[s.jsx("input",{type:"text",placeholder:"Mesaj yaz...",value:v,onChange:e=>C(e.target.value),onKeyPress:e=>e.key==="Enter"&&F()}),s.jsx("button",{onClick:F,children:"GÃ¶nder"})]})]})]}):s.jsxs("div",{className:"watch-together-container",children:[s.jsxs("div",{className:"watch-together-empty",children:[s.jsx("h2",{children:"ðŸ“º Watch Together"}),s.jsx("p",{children:"ArkadaÅŸlarÄ±nla birlikte video izle!"}),s.jsxs("button",{className:"create-party-btn",onClick:()=>m(!0),children:[s.jsx(oe,{})," Yeni Watch Party OluÅŸtur"]}),s.jsxs("div",{className:"supported-platforms",children:[s.jsx("span",{children:"Desteklenen platformlar:"}),s.jsxs("div",{className:"platforms",children:[s.jsx("span",{children:"YouTube"}),s.jsx("span",{children:"Twitch"}),s.jsx("span",{children:"Vimeo"}),s.jsx("span",{children:"Dailymotion"})]})]})]}),M&&s.jsx("div",{className:"watch-modal-overlay",onClick:()=>m(!1),children:s.jsxs("div",{className:"watch-modal",onClick:e=>e.stopPropagation(),children:[s.jsx("h3",{children:"ðŸŽ¬ Watch Party OluÅŸtur"}),s.jsx("input",{type:"url",placeholder:"Video URL'sini yapÄ±ÅŸtÄ±r...",value:j,onChange:e=>$(e.target.value),autoFocus:!0}),s.jsxs("div",{className:"modal-actions",children:[s.jsx("button",{className:"cancel-btn",onClick:()=>m(!1),children:"Ä°ptal"}),s.jsx("button",{className:"create-btn",onClick:ee,disabled:k,children:k?"OluÅŸturuluyor...":"OluÅŸtur"})]})]})})]})},ve=y=>{const d=y.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return d?d[1]:""};export{Pe as default};
