import{r as R,ch as v}from"./react-core-B6hadH-M.js";import{p as T}from"./purify.es-HRjpPm7y.js";import{s as k,t as b,h as S}from"./index-D_6pZib5.js";class $ extends Error{constructor(e,t,s,i=null){super(e),this.name="ApiError",this.status=t,this.code=s,this.data=i,this.timestamp=new Date().toISOString()}toJSON(){return{name:this.name,message:this.message,status:this.status,code:this.code,data:this.data,timestamp:this.timestamp}}}class N{constructor(e=6,t=100){this.queue=[],this.running=0,this.maxConcurrent=e,this.rateLimit=t,this.requestTimes=[]}async add(e){return new Promise((t,s)=>{this.queue.push({fn:e,resolve:t,reject:s}),this.process()})}async process(){if(this.running>=this.maxConcurrent||this.queue.length===0)return;const e=Date.now();if(this.requestTimes=this.requestTimes.filter(r=>e-r<6e4),this.requestTimes.length>=this.rateLimit){setTimeout(()=>this.process(),1e3);return}const{fn:t,resolve:s,reject:i}=this.queue.shift();this.running++,this.requestTimes.push(e);try{const r=await t();s(r)}catch(r){i(r)}finally{this.running--,this.process()}}}class q{constructor(e={}){this.cache=new Map,this.maxSize=e.maxSize||200,this.defaultTTL=e.defaultTTL||300*1e3,this.hits=0,this.misses=0}generateKey(e,t){const s=t?JSON.stringify(Object.keys(t).sort().reduce((i,r)=>(i[r]=t[r],i),{})):"";return`${e}:${s}`}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),this.misses++,null):(this.hits++,t.data):(this.misses++,null)}set(e,t,s=this.defaultTTL){if(this.cache.size>=this.maxSize){const i=this.cache.keys().next().value;this.cache.delete(i)}this.cache.set(e,{data:t,expiry:Date.now()+s,timestamp:Date.now()})}invalidate(e){if(typeof e=="string")for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else if(e instanceof RegExp)for(const t of this.cache.keys())e.test(t)&&this.cache.delete(t)}clear(){this.cache.clear()}getStats(){return{size:this.cache.size,maxSize:this.maxSize,hits:this.hits,misses:this.misses,hitRate:this.hits+this.misses>0?(this.hits/(this.hits+this.misses)*100).toFixed(2)+"%":"0%"}}}class C{constructor(){this.baseURL=k,this.cache=new q,this.queue=new N,this.pendingRequests=new Map,this.interceptors={request:[],response:[],error:[]},this.config={timeout:3e4,retryAttempts:3,retryDelay:1e3,retryMultiplier:2,cacheTTL:{short:30*1e3,medium:300*1e3,long:1800*1e3}},this.setupDefaultInterceptors()}setupDefaultInterceptors(){this.addRequestInterceptor(e=>{const t=localStorage.getItem("access_token");return t&&(e.headers={...e.headers,Authorization:`Bearer ${t}`}),e}),this.addErrorInterceptor(async e=>{if(e.status===401&&await this.refreshToken())return this.request(e.originalConfig);throw e})}addRequestInterceptor(e){this.interceptors.request.push(e)}addResponseInterceptor(e){this.interceptors.response.push(e)}addErrorInterceptor(e){this.interceptors.error.push(e)}buildURL(e,t){const s=new URL(e,this.baseURL);return t&&Object.entries(t).forEach(([i,r])=>{r!=null&&s.searchParams.append(i,r)}),s.toString()}async request(e,t={}){const{method:s="GET",headers:i={},body:r,params:g,cache:f=s==="GET",cacheTTL:u=this.config.cacheTTL.medium,retry:y=!0,deduplicate:h=!0,timeout:l=this.config.timeout,showError:c=!0,...o}=t,E=this.buildURL(e,g),n=this.cache.generateKey(E,g);if(f&&s==="GET"){const d=this.cache.get(n);if(d)return{data:d,fromCache:!0}}if(h&&s==="GET"){const d=this.pendingRequests.get(n);if(d)return d}let a={url:E,method:s,headers:{"Content-Type":"application/json",...i},body:r?JSON.stringify(r):void 0,...o};for(const d of this.interceptors.request)a=await d(a);const p=this.executeRequest(a,{retry:y,timeout:l,showError:c,cacheKey:n,cacheTTL:u,useCache:f,method:s});return h&&s==="GET"&&(this.pendingRequests.set(n,p),p.finally(()=>{this.pendingRequests.delete(n)})),p}async executeRequest(e,t){const{retry:s,timeout:i,showError:r,cacheKey:g,cacheTTL:f,useCache:u,method:y}=t;let h;for(let l=0;l<=(s?this.config.retryAttempts:0);l++)try{const c=await this.queue.add(()=>this.fetchWithTimeout(e.url,{method:e.method,headers:e.headers,body:e.body},i));if(!c.ok){const n=await c.json().catch(()=>({}));throw new $(n.message||n.error||`HTTP Error ${c.status}`,c.status,n.code||"HTTP_ERROR",n)}let o;c.headers.get("content-type")?.includes("application/json")?o=await c.json():o=await c.text();for(const n of this.interceptors.response)o=await n(o,c);return u&&y==="GET"&&this.cache.set(g,o,f),{data:o,fromCache:!1}}catch(c){if(h=c,c.status===401||c.status===403||c.status===404)break;if(l<this.config.retryAttempts){const o=this.config.retryDelay*Math.pow(this.config.retryMultiplier,l);await this.sleep(o)}}for(const l of this.interceptors.error)try{const c=await l({...h,originalConfig:e});if(c)return c}catch(c){h=c}throw r&&b.error(h.message||"Bir hata oluÅŸtu"),h}async fetchWithTimeout(e,t,s){const i=new AbortController,r=setTimeout(()=>i.abort(),s);try{return await fetch(e,{...t,signal:i.signal})}finally{clearTimeout(r)}}async refreshToken(){const e=localStorage.getItem("refresh_token");if(!e)return!1;try{const t=await fetch(`${this.baseURL}/api/auth/refresh/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:e})});if(t.ok){const s=await t.json();return localStorage.setItem("access_token",s.access),!0}}catch(t){console.error("Token refresh failed:",t)}return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),!1}sleep(e){return new Promise(t=>setTimeout(t,e))}async get(e,t={}){return this.request(e,{...t,method:"GET"})}async post(e,t,s={}){const i=await this.request(e,{...s,method:"POST",body:t});return this.cache.invalidate(e.split("/")[0]),i}async put(e,t,s={}){const i=await this.request(e,{...s,method:"PUT",body:t});return this.cache.invalidate(e.split("/")[0]),i}async patch(e,t,s={}){const i=await this.request(e,{...s,method:"PATCH",body:t});return this.cache.invalidate(e.split("/")[0]),i}async delete(e,t={}){const s=await this.request(e,{...t,method:"DELETE"});return this.cache.invalidate(e.split("/")[0]),s}users={getProfile:e=>this.get(`/api/users/${e}/`),updateProfile:(e,t)=>this.patch(`/api/users/${e}/`,t),getSettings:()=>this.get("/api/users/settings/"),updateSettings:e=>this.patch("/api/users/settings/",e),getFriends:()=>this.get("/api/friends/",{cacheTTL:this.config.cacheTTL.short}),sendFriendRequest:e=>this.post("/api/friends/send/",{user_id:e}),getBlocked:()=>this.get("/api/blocked-users/"),blockUser:e=>this.post("/api/blocked-users/",{user_id:e}),unblockUser:e=>this.delete(`/api/blocked-users/${e}/`)};servers={list:()=>this.get("/api/servers/",{cacheTTL:this.config.cacheTTL.short}),get:e=>this.get(`/api/servers/${e}/`),create:e=>this.post("/api/servers/",e),update:(e,t)=>this.patch(`/api/servers/${e}/`,t),delete:e=>this.delete(`/api/servers/${e}/`),getMembers:e=>this.get(`/api/servers/${e}/members/`),getRoles:e=>this.get(`/api/servers/${e}/roles/`),getBoostStats:e=>this.get(`/api/servers/${e}/boost-stats/`)};rooms={list:e=>this.get(`/api/servers/${e}/rooms/`),get:e=>this.get(`/api/rooms/${e}/`),create:(e,t)=>this.post(`/api/servers/${e}/rooms/`,t),update:(e,t)=>this.patch(`/api/rooms/${e}/`,t),delete:e=>this.delete(`/api/rooms/${e}/`),getMessages:(e,t)=>this.get(`/api/rooms/${e}/messages/`,{params:t,cacheTTL:this.config.cacheTTL.short})};messages={send:(e,t)=>this.post(`/api/rooms/${e}/messages/`,t),edit:(e,t)=>this.patch(`/api/messages/${e}/`,{content:t}),delete:e=>this.delete(`/api/messages/${e}/`),pin:e=>this.post(`/api/messages/${e}/pin/`),unpin:e=>this.post(`/api/messages/${e}/unpin/`),react:(e,t)=>this.post(`/api/messages/${e}/react/`,{emoji:t}),search:e=>this.get("/api/messages/search/",{params:e})};auth={login:e=>this.post("/api/auth/login/",e,{showError:!1}),register:e=>this.post("/api/auth/register/",e),logout:()=>this.post("/api/auth/logout/"),refreshToken:()=>this.refreshToken(),verifyEmail:e=>this.post("/api/auth/verify-email/",{token:e}),resetPassword:e=>this.post("/api/auth/reset-password/",{email:e}),enable2FA:()=>this.post("/api/auth/2fa/enable/"),verify2FA:e=>this.post("/api/auth/2fa/verify/",{code:e})};moderation={ban:(e,t,s)=>this.post(`/api/servers/${e}/bans/`,{user_id:t,reason:s}),unban:(e,t)=>this.delete(`/api/servers/${e}/bans/${t}/`),kick:(e,t,s)=>this.post(`/api/servers/${e}/kicks/`,{user_id:t,reason:s}),warn:(e,t,s)=>this.post(`/api/servers/${e}/warnings/`,{user_id:t,reason:s}),getAuditLogs:(e,t)=>this.get(`/api/servers/${e}/audit-logs/`,{params:t})};premium={getPlans:()=>this.get("/api/premium/plans/",{cacheTTL:this.config.cacheTTL.long}),subscribe:(e,t)=>this.post("/api/premium/subscribe/",{plan_id:e,payment_method:t}),cancelSubscription:()=>this.post("/api/premium/cancel/"),getStatus:()=>this.get("/api/premium/status/")};analytics={getServerStats:e=>this.get(`/api/servers/${e}/analytics/`),getUserActivity:()=>this.get("/api/users/analytics/"),trackEvent:(e,t)=>this.post("/api/analytics/events/",{event:e,data:t},{showError:!1})};getCacheStats(){return this.cache.getStats()}clearCache(){this.cache.clear()}invalidateCache(e){this.cache.invalidate(e)}}const w=new C,P=({serverId:m,onClose:e})=>{const[t,s]=R.useState({enabled:!1,keywords:[],dm_notifications:!0,highlight_color:"#fbbf24"}),[i,r]=R.useState([]),[g,f]=R.useState(!0),[u,y]=R.useState("");R.useEffect(()=>{h(),l()},[m]);const h=async()=>{try{const a=await w.get(`/highlights/server/${m}/config/`);s(a)}catch(a){console.error("Fetch config error:",a)}finally{f(!1)}},l=async()=>{try{const a=await w.get(`/highlights/server/${m}/messages/`);r(a)}catch(a){console.error("Fetch highlights error:",a)}},c=async()=>{try{await w.post(`/highlights/server/${m}/config/`,t),v.success("âœ… Highlight ayarlarÄ± kaydedildi")}catch(a){console.error("Save config error:",a),v.error("âŒ Kaydetme hatasÄ±")}},o=()=>{if(u.trim()){if(t.keywords.includes(u.toLowerCase())){v.warning("âš ï¸ Bu kelime zaten ekli");return}s({...t,keywords:[...t.keywords,u.toLowerCase()]}),y("")}},E=a=>{s({...t,keywords:t.keywords.filter(p=>p!==a)})},n=async()=>{if(await S("TÃ¼m highlight geÃ§miÅŸini temizlemek istediÄŸinize emin misiniz?"))try{(await fetch(`${apiBaseUrl}/highlights/server/${m}/clear/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}})).ok&&(v.success("âœ… GeÃ§miÅŸ temizlendi"),r([]))}catch{v.error("âŒ Temizleme hatasÄ±")}};return React.createElement("div",{className:"highlights-overlay",onClick:e},React.createElement("div",{className:"highlights-panel",onClick:a=>a.stopPropagation()},React.createElement("div",{className:"highlights-header"},React.createElement("h2",null,"âœ¨ Highlight Sistemi"),React.createElement("button",{className:"close-btn",onClick:e},"Ã—")),React.createElement("div",{className:"highlights-content"},g?React.createElement("div",{className:"loading-state"},React.createElement("div",{className:"spinner"}),React.createElement("p",null,"YÃ¼kleniyor...")):React.createElement(React.Fragment,null,React.createElement("div",{className:"config-section"},React.createElement("div",{className:"section-header"},React.createElement("h3",null,"âš™ï¸ Ayarlar"),React.createElement("label",{className:"toggle-switch"},React.createElement("input",{type:"checkbox",checked:t.enabled,onChange:a=>s({...t,enabled:a.target.checked})}),React.createElement("span",{className:"toggle-slider"}))),React.createElement("div",{className:"keywords-section"},React.createElement("h4",null,"ðŸ”‘ Anahtar Kelimeler"),React.createElement("div",{className:"keyword-input"},React.createElement("input",{type:"text",value:u,onChange:a=>y(a.target.value),onKeyPress:a=>a.key==="Enter"&&o(),placeholder:"Kelime ekle..."}),React.createElement("button",{onClick:o},"âž•")),t.keywords.length>0&&React.createElement("div",{className:"keywords-list"},t.keywords.map((a,p)=>React.createElement("div",{key:p,className:"keyword-tag"},React.createElement("span",null,a),React.createElement("button",{onClick:()=>E(a)},"Ã—"))))),React.createElement("div",{className:"config-options"},React.createElement("div",{className:"form-group"},React.createElement("label",{className:"checkbox-label"},React.createElement("input",{type:"checkbox",checked:t.dm_notifications,onChange:a=>s({...t,dm_notifications:a.target.checked})}),React.createElement("span",null,"DM bildirimleri gÃ¶nder"))),React.createElement("div",{className:"form-group"},React.createElement("label",null,"Highlight Rengi"),React.createElement("input",{type:"color",value:t.highlight_color,onChange:a=>s({...t,highlight_color:a.target.value})}))),React.createElement("button",{className:"save-btn",onClick:c},"ðŸ’¾ Kaydet")),React.createElement("div",{className:"highlights-section"},React.createElement("div",{className:"section-header"},React.createElement("h3",null,"ðŸ“ Highlight GeÃ§miÅŸi (",i.length,")"),i.length>0&&React.createElement("button",{className:"clear-btn",onClick:n},"ðŸ—‘ï¸ Temizle")),i.length===0?React.createElement("div",{className:"empty-state"},React.createElement("span",{className:"empty-icon"},"âœ¨"),React.createElement("p",null,"HenÃ¼z highlight yok")):React.createElement("div",{className:"highlights-list"},i.map(a=>React.createElement("div",{key:a.id,className:"highlight-card"},React.createElement("div",{className:"highlight-header"},React.createElement("div",{className:"highlight-author"},a.author_avatar?React.createElement("img",{src:a.author_avatar,alt:""}):React.createElement("div",{className:"default-avatar"},"ðŸ‘¤"),React.createElement("div",{className:"author-info"},React.createElement("span",{className:"author-name"},a.author_name),React.createElement("span",{className:"channel-name"},"# ",a.channel_name))),React.createElement("span",{className:"highlight-time"},new Date(a.created_at).toLocaleString("tr-TR"))),React.createElement("div",{className:"highlight-content"},React.createElement("p",{dangerouslySetInnerHTML:{__html:T.sanitize(a.content.replace(new RegExp(`(${t.keywords.join("|")})`,"gi"),`<mark style="background: ${t.highlight_color}; color: #000; padding: 2px 4px; border-radius: 4px;">$1</mark>`))}}))))))))))};export{P as default};
