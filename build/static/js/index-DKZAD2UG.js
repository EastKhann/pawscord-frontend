import{r as a,aI as le,K as oe,l as ie,bS as ue,bT as me,bZ as de,a3 as he,dl as ye,bp as Re}from"./react-core-B6hadH-M.js";import{W as fe,q as pe,t as i,A as F}from"./index-D_6pZib5.js";const ge=({roomId:R,onClose:u})=>{const[n,f]=a.useState(null),[N,k]=a.useState(!1),[M,h]=a.useState(!1),[p,$]=a.useState(""),[V,S]=a.useState([]),[A,J]=a.useState([]),[E,_]=a.useState(""),[s,L]=a.useState(!1),[m,b]=a.useState(!1),[l,P]=a.useState(0),[v,U]=a.useState(!1),[x,C]=a.useState(!1),[O,z]=a.useState(!0),[B,W]=a.useState([]),r=a.useRef(null),o=a.useRef(null),g=a.useRef(null),T=a.useRef(null),w=a.useRef(null),y=localStorage.getItem("access_token"),j=a.useCallback(e=>{r.current&&r.current.close();const t=`${fe}://${pe}/ws/watch-party/${e}/?token=${y}`,c=new WebSocket(t);c.onopen=()=>{c.send(JSON.stringify({type:"request_sync"}))},c.onmessage=d=>{const se=JSON.parse(d.data);q(se)},c.onclose=()=>{},c.onerror=d=>{console.error("ðŸ“º Watch Party WebSocket error:",d)},r.current=c,w.current=setInterval(()=>{c.readyState===WebSocket.OPEN&&c.send(JSON.stringify({type:"heartbeat",local_time:l,is_buffering:!1}))},5e3)},[y,l]),q=e=>{switch(e.type){case"sync_playback":D(e);break;case"reaction":H(e);break;case"chat_message":Y(e);break;case"viewer_joined":K(e);break;case"viewer_left":Z(e);break;case"party_ended":G();break;case"video_changed":Q(e);break}},D=e=>{(e.by_user==="system"||!s)&&(P(e.current_time),b(e.status==="playing"),o.current&&(o.current.seekTo(e.current_time),e.status==="playing"?o.current.play():o.current.pause()))},H=e=>{const t=Date.now()+Math.random();W(c=>[...c,{...e,id:t}]),setTimeout(()=>{W(c=>c.filter(d=>d.id!==t))},3e3)},Y=e=>{J(t=>[...t,e]),setTimeout(()=>{T.current?.scrollIntoView({behavior:"smooth"})},100)},K=e=>{i.success(`${e.username} katÄ±ldÄ±!`),S(t=>t.find(c=>c.username===e.username)?t:[...t,{username:e.username,id:e.user_id}])},Z=e=>{S(t=>t.filter(c=>c.username!==e.username))},G=e=>{i.info("Watch Party sona erdi"),f(null),u?.()},Q=e=>{f(t=>({...t,video_url:e.video_url,video_title:e.video_title,embed_url:e.embed_url})),P(0),b(!1)},X=async()=>{if(!p.trim()){i.error("Video URL gerekli");return}k(!0);try{const e=await fetch(`${F}/rooms/${R}/watch-party/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`},body:JSON.stringify({video_url:p,allow_control:!1})});if(e.ok){const t=await e.json();f(t),L(!0),h(!1),j(t.id),i.success("Watch Party oluÅŸturuldu! ðŸŽ‰")}else{const t=await e.json();i.error(t.error||"Watch Party oluÅŸturulamadÄ±")}}catch(e){console.error("Watch Party create error:",e),i.error("BaÄŸlantÄ± hatasÄ±")}finally{k(!1)}},ee=e=>{!s||!r.current||r.current.send(JSON.stringify({type:"sync",action:e,current_time:l,playback_rate:1}))},te=e=>{r.current&&r.current.send(JSON.stringify({type:"reaction",emoji:e,video_time:l}))},I=()=>{!E.trim()||!r.current||(r.current.send(JSON.stringify({type:"message",content:E,video_time:l})),_(""))},ae=async()=>{if(!(!n||!s))try{await fetch(`${F}/watch-party/${n.id}/end/`,{method:"POST",headers:{Authorization:`Bearer ${y}`}})}catch(e){console.error("End party error:",e)}},ce=()=>{s&&ee(m?"pause":"play"),b(!m)},re=()=>{g.current&&(document.fullscreenElement?(document.exitFullscreen(),C(!1)):(g.current.requestFullscreen(),C(!0)))};a.useEffect(()=>()=>{r.current&&r.current.close(),w.current&&clearInterval(w.current)},[]);const ne=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ”¥","ðŸ‘","ðŸŽ‰"];return n?React.createElement("div",{className:"watch-together-container",ref:g},React.createElement("div",{className:"watch-header"},React.createElement("div",{className:"watch-title"},React.createElement("span",{className:"live-badge"},"CANLI"),React.createElement("h3",null,n.video_title||"Watch Party")),React.createElement("div",{className:"watch-viewers"},React.createElement(oe,null),React.createElement("span",null,V.length," izleyici")),React.createElement("button",{className:"close-btn",onClick:u},React.createElement(ie,null))),React.createElement("div",{className:"watch-player"},n.video_source==="youtube"&&React.createElement("iframe",{ref:o,src:`https://www.youtube.com/embed/${Ee(n.video_url)}?autoplay=${m?1:0}&start=${Math.floor(l)}&enablejsapi=1`,title:"Watch Party",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),n.video_source==="direct"&&React.createElement("video",{ref:o,src:n.video_url,autoPlay:m,muted:v}),React.createElement("div",{className:"reaction-overlay"},B.map(e=>React.createElement("div",{key:e.id,className:"floating-reaction",style:{left:`${Math.random()*80+10}%`}},e.emoji)))),React.createElement("div",{className:"watch-controls"},React.createElement("div",{className:"control-left"},s&&React.createElement("button",{onClick:ce},m?React.createElement(ue,null):React.createElement(me,null)),React.createElement("button",{onClick:()=>U(!v)},v?React.createElement(de,null):React.createElement(he,null))),React.createElement("div",{className:"reactions-bar"},ne.map(e=>React.createElement("button",{key:e,className:"reaction-btn",onClick:()=>te(e)},e))),React.createElement("div",{className:"control-right"},React.createElement("button",{onClick:()=>z(!O)},"ðŸ’¬"),React.createElement("button",{onClick:re},x?React.createElement(ye,null):React.createElement(Re,null)),s&&React.createElement("button",{className:"end-btn",onClick:ae},"Bitir"))),O&&React.createElement("div",{className:"watch-chat"},React.createElement("div",{className:"chat-messages"},A.map((e,t)=>React.createElement("div",{key:t,className:"chat-message"},React.createElement("img",{src:e.avatar||"/default-avatar.png",alt:e.user,className:"chat-avatar"}),React.createElement("div",{className:"chat-content"},React.createElement("span",{className:"chat-user"},e.user),React.createElement("span",{className:"chat-text"},e.content)))),React.createElement("div",{ref:T})),React.createElement("div",{className:"chat-input"},React.createElement("input",{type:"text",placeholder:"Mesaj yaz...",value:E,onChange:e=>_(e.target.value),onKeyPress:e=>e.key==="Enter"&&I()}),React.createElement("button",{onClick:I},"GÃ¶nder")))):React.createElement("div",{className:"watch-together-container"},React.createElement("div",{className:"watch-together-empty"},React.createElement("h2",null,"ðŸ“º Watch Together"),React.createElement("p",null,"ArkadaÅŸlarÄ±nla birlikte video izle!"),React.createElement("button",{className:"create-party-btn",onClick:()=>h(!0)},React.createElement(le,null)," Yeni Watch Party OluÅŸtur"),React.createElement("div",{className:"supported-platforms"},React.createElement("span",null,"Desteklenen platformlar:"),React.createElement("div",{className:"platforms"},React.createElement("span",null,"YouTube"),React.createElement("span",null,"Twitch"),React.createElement("span",null,"Vimeo"),React.createElement("span",null,"Dailymotion")))),M&&React.createElement("div",{className:"watch-modal-overlay",onClick:()=>h(!1)},React.createElement("div",{className:"watch-modal",onClick:e=>e.stopPropagation()},React.createElement("h3",null,"ðŸŽ¬ Watch Party OluÅŸtur"),React.createElement("input",{type:"url",placeholder:"Video URL'sini yapÄ±ÅŸtÄ±r...",value:p,onChange:e=>$(e.target.value),autoFocus:!0}),React.createElement("div",{className:"modal-actions"},React.createElement("button",{className:"cancel-btn",onClick:()=>h(!1)},"Ä°ptal"),React.createElement("button",{className:"create-btn",onClick:X,disabled:N},N?"OluÅŸturuluyor...":"OluÅŸtur")))))},Ee=R=>{const u=R.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return u?u[1]:""};export{ge as default};
