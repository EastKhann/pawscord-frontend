var b=Object.defineProperty;var S=(c,e,t)=>e in c?b(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var p=(c,e,t)=>S(c,typeof e!="symbol"?e+"":e,t);import{r as T,n as s}from"./react-core-BMiyQWF6.js";import{y as k}from"./ui-vendor-6RMGJYFH.js";import{p as $}from"./purify.es-FVN2sLic.js";import{p as N,t as q}from"./index-w75Xg-ox.js";import"./editor-vendor-D9c4a6XZ.js";import"./media-vendor-BuSyE8vR.js";import"./router-vendor-B86Z1mIL.js";import"./icons-vendor-T72gfvdf.js";import"./state-vendor-CAyNnPM4.js";import"./crypto-vendor-1Q6e4ZD-.js";class E extends Error{constructor(e,t,i,a=null){super(e),this.name="ApiError",this.status=t,this.code=i,this.data=a,this.timestamp=new Date().toISOString()}toJSON(){return{name:this.name,message:this.message,status:this.status,code:this.code,data:this.data,timestamp:this.timestamp}}}class C{constructor(e=6,t=100){this.queue=[],this.running=0,this.maxConcurrent=e,this.rateLimit=t,this.requestTimes=[]}async add(e){return new Promise((t,i)=>{this.queue.push({fn:e,resolve:t,reject:i}),this.process()})}async process(){if(this.running>=this.maxConcurrent||this.queue.length===0)return;const e=Date.now();if(this.requestTimes=this.requestTimes.filter(h=>e-h<6e4),this.requestTimes.length>=this.rateLimit){setTimeout(()=>this.process(),1e3);return}const{fn:t,resolve:i,reject:a}=this.queue.shift();this.running++,this.requestTimes.push(e);try{const h=await t();i(h)}catch(h){a(h)}finally{this.running--,this.process()}}}class L{constructor(e={}){this.cache=new Map,this.maxSize=e.maxSize||200,this.defaultTTL=e.defaultTTL||300*1e3,this.hits=0,this.misses=0}generateKey(e,t){const i=t?JSON.stringify(Object.keys(t).sort().reduce((a,h)=>(a[h]=t[h],a),{})):"";return`${e}:${i}`}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),this.misses++,null):(this.hits++,t.data):(this.misses++,null)}set(e,t,i=this.defaultTTL){if(this.cache.size>=this.maxSize){const a=this.cache.keys().next().value;this.cache.delete(a)}this.cache.set(e,{data:t,expiry:Date.now()+i,timestamp:Date.now()})}invalidate(e){if(typeof e=="string")for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else if(e instanceof RegExp)for(const t of this.cache.keys())e.test(t)&&this.cache.delete(t)}clear(){this.cache.clear()}getStats(){return{size:this.cache.size,maxSize:this.maxSize,hits:this.hits,misses:this.misses,hitRate:this.hits+this.misses>0?(this.hits/(this.hits+this.misses)*100).toFixed(2)+"%":"0%"}}}class _{constructor(){p(this,"users",{getProfile:e=>this.get(`/api/users/${e}/`),updateProfile:(e,t)=>this.patch(`/api/users/${e}/`,t),getSettings:()=>this.get("/api/users/settings/"),updateSettings:e=>this.patch("/api/users/settings/",e),getFriends:()=>this.get("/api/friends/",{cacheTTL:this.config.cacheTTL.short}),sendFriendRequest:e=>this.post("/api/friends/send/",{user_id:e}),getBlocked:()=>this.get("/api/blocked-users/"),blockUser:e=>this.post("/api/blocked-users/",{user_id:e}),unblockUser:e=>this.delete(`/api/blocked-users/${e}/`)});p(this,"servers",{list:()=>this.get("/api/servers/",{cacheTTL:this.config.cacheTTL.short}),get:e=>this.get(`/api/servers/${e}/`),create:e=>this.post("/api/servers/",e),update:(e,t)=>this.patch(`/api/servers/${e}/`,t),delete:e=>this.delete(`/api/servers/${e}/`),getMembers:e=>this.get(`/api/servers/${e}/members/`),getRoles:e=>this.get(`/api/servers/${e}/roles/`),getBoostStats:e=>this.get(`/api/servers/${e}/boost-stats/`)});p(this,"rooms",{list:e=>this.get(`/api/servers/${e}/rooms/`),get:e=>this.get(`/api/rooms/${e}/`),create:(e,t)=>this.post(`/api/servers/${e}/rooms/`,t),update:(e,t)=>this.patch(`/api/rooms/${e}/`,t),delete:e=>this.delete(`/api/rooms/${e}/`),getMessages:(e,t)=>this.get(`/api/rooms/${e}/messages/`,{params:t,cacheTTL:this.config.cacheTTL.short})});p(this,"messages",{send:(e,t)=>this.post(`/api/rooms/${e}/messages/`,t),edit:(e,t)=>this.patch(`/api/messages/${e}/`,{content:t}),delete:e=>this.delete(`/api/messages/${e}/`),pin:e=>this.post(`/api/messages/${e}/pin/`),unpin:e=>this.post(`/api/messages/${e}/unpin/`),react:(e,t)=>this.post(`/api/messages/${e}/react/`,{emoji:t}),search:e=>this.get("/api/messages/search/",{params:e})});p(this,"auth",{login:e=>this.post("/api/auth/login/",e,{showError:!1}),register:e=>this.post("/api/auth/register/",e),logout:()=>this.post("/api/auth/logout/"),refreshToken:()=>this.refreshToken(),verifyEmail:e=>this.post("/api/auth/verify-email/",{token:e}),resetPassword:e=>this.post("/api/auth/reset-password/",{email:e}),enable2FA:()=>this.post("/api/auth/2fa/enable/"),verify2FA:e=>this.post("/api/auth/2fa/verify/",{code:e})});p(this,"moderation",{ban:(e,t,i)=>this.post(`/api/servers/${e}/bans/`,{user_id:t,reason:i}),unban:(e,t)=>this.delete(`/api/servers/${e}/bans/${t}/`),kick:(e,t,i)=>this.post(`/api/servers/${e}/kicks/`,{user_id:t,reason:i}),warn:(e,t,i)=>this.post(`/api/servers/${e}/warnings/`,{user_id:t,reason:i}),getAuditLogs:(e,t)=>this.get(`/api/servers/${e}/audit-logs/`,{params:t})});p(this,"premium",{getPlans:()=>this.get("/api/premium/plans/",{cacheTTL:this.config.cacheTTL.long}),subscribe:(e,t)=>this.post("/api/premium/subscribe/",{plan_id:e,payment_method:t}),cancelSubscription:()=>this.post("/api/premium/cancel/"),getStatus:()=>this.get("/api/premium/status/")});p(this,"analytics",{getServerStats:e=>this.get(`/api/servers/${e}/analytics/`),getUserActivity:()=>this.get("/api/users/analytics/"),trackEvent:(e,t)=>this.post("/api/analytics/events/",{event:e,data:t},{showError:!1})});this.baseURL=N,this.cache=new L,this.queue=new C,this.pendingRequests=new Map,this.interceptors={request:[],response:[],error:[]},this.config={timeout:3e4,retryAttempts:3,retryDelay:1e3,retryMultiplier:2,cacheTTL:{short:30*1e3,medium:300*1e3,long:1800*1e3}},this.setupDefaultInterceptors()}setupDefaultInterceptors(){this.addRequestInterceptor(e=>{const t=localStorage.getItem("access_token");return t&&(e.headers={...e.headers,Authorization:`Bearer ${t}`}),e}),this.addErrorInterceptor(async e=>{if(e.status===401&&await this.refreshToken())return this.request(e.originalConfig);throw e})}addRequestInterceptor(e){this.interceptors.request.push(e)}addResponseInterceptor(e){this.interceptors.response.push(e)}addErrorInterceptor(e){this.interceptors.error.push(e)}buildURL(e,t){const i=new URL(e,this.baseURL);return t&&Object.entries(t).forEach(([a,h])=>{h!=null&&i.searchParams.append(a,h)}),i.toString()}async request(e,t={}){const{method:i="GET",headers:a={},body:h,params:m,cache:x=i==="GET",cacheTTL:g=this.config.cacheTTL.medium,retry:w=!0,deduplicate:d=!0,timeout:u=this.config.timeout,showError:n=!0,...l}=t,v=this.buildURL(e,m),o=this.cache.generateKey(v,m);if(x&&i==="GET"){const y=this.cache.get(o);if(y)return{data:y,fromCache:!0}}if(d&&i==="GET"){const y=this.pendingRequests.get(o);if(y)return y}let r={url:v,method:i,headers:{"Content-Type":"application/json",...a},body:h?JSON.stringify(h):void 0,...l};for(const y of this.interceptors.request)r=await y(r);const f=this.executeRequest(r,{retry:w,timeout:u,showError:n,cacheKey:o,cacheTTL:g,useCache:x,method:i});return d&&i==="GET"&&(this.pendingRequests.set(o,f),f.finally(()=>{this.pendingRequests.delete(o)})),f}async executeRequest(e,t){const{retry:i,timeout:a,showError:h,cacheKey:m,cacheTTL:x,useCache:g,method:w}=t;let d;for(let u=0;u<=(i?this.config.retryAttempts:0);u++)try{const n=await this.queue.add(()=>this.fetchWithTimeout(e.url,{method:e.method,headers:e.headers,body:e.body},a));if(!n.ok){const o=await n.json().catch(()=>({}));throw new E(o.message||o.error||`HTTP Error ${n.status}`,n.status,o.code||"HTTP_ERROR",o)}let l;n.headers.get("content-type")?.includes("application/json")?l=await n.json():l=await n.text();for(const o of this.interceptors.response)l=await o(l,n);return g&&w==="GET"&&this.cache.set(m,l,x),{data:l,fromCache:!1}}catch(n){if(d=n,n.status===401||n.status===403||n.status===404)break;if(u<this.config.retryAttempts){const l=this.config.retryDelay*Math.pow(this.config.retryMultiplier,u);await this.sleep(l)}}for(const u of this.interceptors.error)try{const n=await u({...d,originalConfig:e});if(n)return n}catch(n){d=n}throw h&&q.error(d.message||"Bir hata oluÅŸtu"),d}async fetchWithTimeout(e,t,i){const a=new AbortController,h=setTimeout(()=>a.abort(),i);try{return await fetch(e,{...t,signal:a.signal})}finally{clearTimeout(h)}}async refreshToken(){const e=localStorage.getItem("refresh_token");if(!e)return!1;try{const t=await fetch(`${this.baseURL}/api/auth/refresh/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:e})});if(t.ok){const i=await t.json();return localStorage.setItem("access_token",i.access),!0}}catch{}return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),!1}sleep(e){return new Promise(t=>setTimeout(t,e))}async get(e,t={}){return this.request(e,{...t,method:"GET"})}async post(e,t,i={}){const a=await this.request(e,{...i,method:"POST",body:t});return this.cache.invalidate(e.split("/")[0]),a}async put(e,t,i={}){const a=await this.request(e,{...i,method:"PUT",body:t});return this.cache.invalidate(e.split("/")[0]),a}async patch(e,t,i={}){const a=await this.request(e,{...i,method:"PATCH",body:t});return this.cache.invalidate(e.split("/")[0]),a}async delete(e,t={}){const i=await this.request(e,{...t,method:"DELETE"});return this.cache.invalidate(e.split("/")[0]),i}getCacheStats(){return this.cache.getStats()}clearCache(){this.cache.clear()}invalidateCache(e){this.cache.invalidate(e)}}const j=new _,M=({serverId:c,onClose:e})=>{const[t,i]=T.useState({enabled:!1,keywords:[],dm_notifications:!0,highlight_color:"#fbbf24"}),[a,h]=T.useState([]),[m,x]=T.useState(!0),[g,w]=T.useState("");T.useEffect(()=>{d(),u()},[c]);const d=async()=>{try{const r=await j.get(`/highlights/server/${c}/config/`);i(r)}catch{}finally{x(!1)}},u=async()=>{try{const r=await j.get(`/highlights/server/${c}/messages/`);h(r)}catch{}},n=async()=>{try{await j.post(`/highlights/server/${c}/config/`,t),k.success("âœ… Highlight ayarlarÄ± kaydedildi")}catch{k.error("âŒ Kaydetme hatasÄ±")}},l=()=>{if(g.trim()){if(t.keywords.includes(g.toLowerCase())){k.warning("âš ï¸ Bu kelime zaten ekli");return}i({...t,keywords:[...t.keywords,g.toLowerCase()]}),w("")}},v=r=>{i({...t,keywords:t.keywords.filter(f=>f!==r)})},o=async()=>{if(window.confirm("TÃ¼m highlight geÃ§miÅŸini temizlemek istediÄŸinize emin misiniz?"))try{(await fetch(`${apiBaseUrl}/highlights/server/${c}/clear/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}})).ok&&(k.success("âœ… GeÃ§miÅŸ temizlendi"),h([]))}catch{k.error("âŒ Temizleme hatasÄ±")}};return s.jsx("div",{className:"highlights-overlay",onClick:e,children:s.jsxs("div",{className:"highlights-panel",onClick:r=>r.stopPropagation(),children:[s.jsxs("div",{className:"highlights-header",children:[s.jsx("h2",{children:"âœ¨ Highlight Sistemi"}),s.jsx("button",{className:"close-btn",onClick:e,children:"Ã—"})]}),s.jsx("div",{className:"highlights-content",children:m?s.jsxs("div",{className:"loading-state",children:[s.jsx("div",{className:"spinner"}),s.jsx("p",{children:"YÃ¼kleniyor..."})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"config-section",children:[s.jsxs("div",{className:"section-header",children:[s.jsx("h3",{children:"âš™ï¸ Ayarlar"}),s.jsxs("label",{className:"toggle-switch",children:[s.jsx("input",{type:"checkbox",checked:t.enabled,onChange:r=>i({...t,enabled:r.target.checked})}),s.jsx("span",{className:"toggle-slider"})]})]}),s.jsxs("div",{className:"keywords-section",children:[s.jsx("h4",{children:"ðŸ”‘ Anahtar Kelimeler"}),s.jsxs("div",{className:"keyword-input",children:[s.jsx("input",{type:"text",value:g,onChange:r=>w(r.target.value),onKeyPress:r=>r.key==="Enter"&&l(),placeholder:"Kelime ekle..."}),s.jsx("button",{onClick:l,children:"âž•"})]}),t.keywords.length>0&&s.jsx("div",{className:"keywords-list",children:t.keywords.map((r,f)=>s.jsxs("div",{className:"keyword-tag",children:[s.jsx("span",{children:r}),s.jsx("button",{onClick:()=>v(r),children:"Ã—"})]},f))})]}),s.jsxs("div",{className:"config-options",children:[s.jsx("div",{className:"form-group",children:s.jsxs("label",{className:"checkbox-label",children:[s.jsx("input",{type:"checkbox",checked:t.dm_notifications,onChange:r=>i({...t,dm_notifications:r.target.checked})}),s.jsx("span",{children:"DM bildirimleri gÃ¶nder"})]})}),s.jsxs("div",{className:"form-group",children:[s.jsx("label",{children:"Highlight Rengi"}),s.jsx("input",{type:"color",value:t.highlight_color,onChange:r=>i({...t,highlight_color:r.target.value})})]})]}),s.jsx("button",{className:"save-btn",onClick:n,children:"ðŸ’¾ Kaydet"})]}),s.jsxs("div",{className:"highlights-section",children:[s.jsxs("div",{className:"section-header",children:[s.jsxs("h3",{children:["ðŸ“ Highlight GeÃ§miÅŸi (",a.length,")"]}),a.length>0&&s.jsx("button",{className:"clear-btn",onClick:o,children:"ðŸ—‘ï¸ Temizle"})]}),a.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("span",{className:"empty-icon",children:"âœ¨"}),s.jsx("p",{children:"HenÃ¼z highlight yok"})]}):s.jsx("div",{className:"highlights-list",children:a.map(r=>s.jsxs("div",{className:"highlight-card",children:[s.jsxs("div",{className:"highlight-header",children:[s.jsxs("div",{className:"highlight-author",children:[r.author_avatar?s.jsx("img",{src:r.author_avatar,alt:""}):s.jsx("div",{className:"default-avatar",children:"ðŸ‘¤"}),s.jsxs("div",{className:"author-info",children:[s.jsx("span",{className:"author-name",children:r.author_name}),s.jsxs("span",{className:"channel-name",children:["# ",r.channel_name]})]})]}),s.jsx("span",{className:"highlight-time",children:new Date(r.created_at).toLocaleString("tr-TR")})]}),s.jsx("div",{className:"highlight-content",children:s.jsx("p",{dangerouslySetInnerHTML:{__html:$.sanitize(r.content.replace(new RegExp(`(${t.keywords.join("|")})`,"gi"),`<mark style="background: ${t.highlight_color}; color: #000; padding: 2px 4px; border-radius: 4px;">$1</mark>`))}})})]},r.id))})]})]})})]})})};export{M as default};
