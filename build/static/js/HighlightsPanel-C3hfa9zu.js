import{r as v,d as s,c9 as T}from"./react-core-DrOm_csO.js";import{p as b}from"./purify.es-HRjpPm7y.js";import{q as S,t as $}from"./index-BYhWpPLp.js";class N extends Error{constructor(e,t,i,r=null){super(e),this.name="ApiError",this.status=t,this.code=i,this.data=r,this.timestamp=new Date().toISOString()}toJSON(){return{name:this.name,message:this.message,status:this.status,code:this.code,data:this.data,timestamp:this.timestamp}}}class q{constructor(e=6,t=100){this.queue=[],this.running=0,this.maxConcurrent=e,this.rateLimit=t,this.requestTimes=[]}async add(e){return new Promise((t,i)=>{this.queue.push({fn:e,resolve:t,reject:i}),this.process()})}async process(){if(this.running>=this.maxConcurrent||this.queue.length===0)return;const e=Date.now();if(this.requestTimes=this.requestTimes.filter(n=>e-n<6e4),this.requestTimes.length>=this.rateLimit){setTimeout(()=>this.process(),1e3);return}const{fn:t,resolve:i,reject:r}=this.queue.shift();this.running++,this.requestTimes.push(e);try{const n=await t();i(n)}catch(n){r(n)}finally{this.running--,this.process()}}}class C{constructor(e={}){this.cache=new Map,this.maxSize=e.maxSize||200,this.defaultTTL=e.defaultTTL||300*1e3,this.hits=0,this.misses=0}generateKey(e,t){const i=t?JSON.stringify(Object.keys(t).sort().reduce((r,n)=>(r[n]=t[n],r),{})):"";return`${e}:${i}`}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),this.misses++,null):(this.hits++,t.data):(this.misses++,null)}set(e,t,i=this.defaultTTL){if(this.cache.size>=this.maxSize){const r=this.cache.keys().next().value;this.cache.delete(r)}this.cache.set(e,{data:t,expiry:Date.now()+i,timestamp:Date.now()})}invalidate(e){if(typeof e=="string")for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else if(e instanceof RegExp)for(const t of this.cache.keys())e.test(t)&&this.cache.delete(t)}clear(){this.cache.clear()}getStats(){return{size:this.cache.size,maxSize:this.maxSize,hits:this.hits,misses:this.misses,hitRate:this.hits+this.misses>0?(this.hits/(this.hits+this.misses)*100).toFixed(2)+"%":"0%"}}}class L{constructor(){this.baseURL=S,this.cache=new C,this.queue=new q,this.pendingRequests=new Map,this.interceptors={request:[],response:[],error:[]},this.config={timeout:3e4,retryAttempts:3,retryDelay:1e3,retryMultiplier:2,cacheTTL:{short:30*1e3,medium:300*1e3,long:1800*1e3}},this.setupDefaultInterceptors()}setupDefaultInterceptors(){this.addRequestInterceptor(e=>{const t=localStorage.getItem("access_token");return t&&(e.headers={...e.headers,Authorization:`Bearer ${t}`}),e}),this.addErrorInterceptor(async e=>{if(e.status===401&&await this.refreshToken())return this.request(e.originalConfig);throw e})}addRequestInterceptor(e){this.interceptors.request.push(e)}addResponseInterceptor(e){this.interceptors.response.push(e)}addErrorInterceptor(e){this.interceptors.error.push(e)}buildURL(e,t){const i=new URL(e,this.baseURL);return t&&Object.entries(t).forEach(([r,n])=>{n!=null&&i.searchParams.append(r,n)}),i.toString()}async request(e,t={}){const{method:i="GET",headers:r={},body:n,params:p,cache:y=i==="GET",cacheTTL:g=this.config.cacheTTL.medium,retry:E=!0,deduplicate:l=!0,timeout:m=this.config.timeout,showError:c=!0,...h}=t,w=this.buildURL(e,p),o=this.cache.generateKey(w,p);if(y&&i==="GET"){const f=this.cache.get(o);if(f)return{data:f,fromCache:!0}}if(l&&i==="GET"){const f=this.pendingRequests.get(o);if(f)return f}let a={url:w,method:i,headers:{"Content-Type":"application/json",...r},body:n?JSON.stringify(n):void 0,...h};for(const f of this.interceptors.request)a=await f(a);const d=this.executeRequest(a,{retry:E,timeout:m,showError:c,cacheKey:o,cacheTTL:g,useCache:y,method:i});return l&&i==="GET"&&(this.pendingRequests.set(o,d),d.finally(()=>{this.pendingRequests.delete(o)})),d}async executeRequest(e,t){const{retry:i,timeout:r,showError:n,cacheKey:p,cacheTTL:y,useCache:g,method:E}=t;let l;for(let m=0;m<=(i?this.config.retryAttempts:0);m++)try{const c=await this.queue.add(()=>this.fetchWithTimeout(e.url,{method:e.method,headers:e.headers,body:e.body},r));if(!c.ok){const o=await c.json().catch(()=>({}));throw new N(o.message||o.error||`HTTP Error ${c.status}`,c.status,o.code||"HTTP_ERROR",o)}let h;c.headers.get("content-type")?.includes("application/json")?h=await c.json():h=await c.text();for(const o of this.interceptors.response)h=await o(h,c);return g&&E==="GET"&&this.cache.set(p,h,y),{data:h,fromCache:!1}}catch(c){if(l=c,c.status===401||c.status===403||c.status===404)break;if(m<this.config.retryAttempts){const h=this.config.retryDelay*Math.pow(this.config.retryMultiplier,m);await this.sleep(h)}}for(const m of this.interceptors.error)try{const c=await m({...l,originalConfig:e});if(c)return c}catch(c){l=c}throw n&&$.error(l.message||"Bir hata oluÅŸtu"),l}async fetchWithTimeout(e,t,i){const r=new AbortController,n=setTimeout(()=>r.abort(),i);try{return await fetch(e,{...t,signal:r.signal})}finally{clearTimeout(n)}}async refreshToken(){const e=localStorage.getItem("refresh_token");if(!e)return!1;try{const t=await fetch(`${this.baseURL}/api/auth/refresh/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:e})});if(t.ok){const i=await t.json();return localStorage.setItem("access_token",i.access),!0}}catch(t){console.error("Token refresh failed:",t)}return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),!1}sleep(e){return new Promise(t=>setTimeout(t,e))}async get(e,t={}){return this.request(e,{...t,method:"GET"})}async post(e,t,i={}){const r=await this.request(e,{...i,method:"POST",body:t});return this.cache.invalidate(e.split("/")[0]),r}async put(e,t,i={}){const r=await this.request(e,{...i,method:"PUT",body:t});return this.cache.invalidate(e.split("/")[0]),r}async patch(e,t,i={}){const r=await this.request(e,{...i,method:"PATCH",body:t});return this.cache.invalidate(e.split("/")[0]),r}async delete(e,t={}){const i=await this.request(e,{...t,method:"DELETE"});return this.cache.invalidate(e.split("/")[0]),i}users={getProfile:e=>this.get(`/api/users/${e}/`),updateProfile:(e,t)=>this.patch(`/api/users/${e}/`,t),getSettings:()=>this.get("/api/users/settings/"),updateSettings:e=>this.patch("/api/users/settings/",e),getFriends:()=>this.get("/api/friends/",{cacheTTL:this.config.cacheTTL.short}),sendFriendRequest:e=>this.post("/api/friends/send/",{user_id:e}),getBlocked:()=>this.get("/api/blocked-users/"),blockUser:e=>this.post("/api/blocked-users/",{user_id:e}),unblockUser:e=>this.delete(`/api/blocked-users/${e}/`)};servers={list:()=>this.get("/api/servers/",{cacheTTL:this.config.cacheTTL.short}),get:e=>this.get(`/api/servers/${e}/`),create:e=>this.post("/api/servers/",e),update:(e,t)=>this.patch(`/api/servers/${e}/`,t),delete:e=>this.delete(`/api/servers/${e}/`),getMembers:e=>this.get(`/api/servers/${e}/members/`),getRoles:e=>this.get(`/api/servers/${e}/roles/`),getBoostStats:e=>this.get(`/api/servers/${e}/boost-stats/`)};rooms={list:e=>this.get(`/api/servers/${e}/rooms/`),get:e=>this.get(`/api/rooms/${e}/`),create:(e,t)=>this.post(`/api/servers/${e}/rooms/`,t),update:(e,t)=>this.patch(`/api/rooms/${e}/`,t),delete:e=>this.delete(`/api/rooms/${e}/`),getMessages:(e,t)=>this.get(`/api/rooms/${e}/messages/`,{params:t,cacheTTL:this.config.cacheTTL.short})};messages={send:(e,t)=>this.post(`/api/rooms/${e}/messages/`,t),edit:(e,t)=>this.patch(`/api/messages/${e}/`,{content:t}),delete:e=>this.delete(`/api/messages/${e}/`),pin:e=>this.post(`/api/messages/${e}/pin/`),unpin:e=>this.post(`/api/messages/${e}/unpin/`),react:(e,t)=>this.post(`/api/messages/${e}/react/`,{emoji:t}),search:e=>this.get("/api/messages/search/",{params:e})};auth={login:e=>this.post("/api/auth/login/",e,{showError:!1}),register:e=>this.post("/api/auth/register/",e),logout:()=>this.post("/api/auth/logout/"),refreshToken:()=>this.refreshToken(),verifyEmail:e=>this.post("/api/auth/verify-email/",{token:e}),resetPassword:e=>this.post("/api/auth/reset-password/",{email:e}),enable2FA:()=>this.post("/api/auth/2fa/enable/"),verify2FA:e=>this.post("/api/auth/2fa/verify/",{code:e})};moderation={ban:(e,t,i)=>this.post(`/api/servers/${e}/bans/`,{user_id:t,reason:i}),unban:(e,t)=>this.delete(`/api/servers/${e}/bans/${t}/`),kick:(e,t,i)=>this.post(`/api/servers/${e}/kicks/`,{user_id:t,reason:i}),warn:(e,t,i)=>this.post(`/api/servers/${e}/warnings/`,{user_id:t,reason:i}),getAuditLogs:(e,t)=>this.get(`/api/servers/${e}/audit-logs/`,{params:t})};premium={getPlans:()=>this.get("/api/premium/plans/",{cacheTTL:this.config.cacheTTL.long}),subscribe:(e,t)=>this.post("/api/premium/subscribe/",{plan_id:e,payment_method:t}),cancelSubscription:()=>this.post("/api/premium/cancel/"),getStatus:()=>this.get("/api/premium/status/")};analytics={getServerStats:e=>this.get(`/api/servers/${e}/analytics/`),getUserActivity:()=>this.get("/api/users/analytics/"),trackEvent:(e,t)=>this.post("/api/analytics/events/",{event:e,data:t},{showError:!1})};getCacheStats(){return this.cache.getStats()}clearCache(){this.cache.clear()}invalidateCache(e){this.cache.invalidate(e)}}const k=new L,P=({serverId:u,onClose:e})=>{const[t,i]=v.useState({enabled:!1,keywords:[],dm_notifications:!0,highlight_color:"#fbbf24"}),[r,n]=v.useState([]),[p,y]=v.useState(!0),[g,E]=v.useState("");v.useEffect(()=>{l(),m()},[u]);const l=async()=>{try{const a=await k.get(`/highlights/server/${u}/config/`);i(a)}catch(a){console.error("Fetch config error:",a)}finally{y(!1)}},m=async()=>{try{const a=await k.get(`/highlights/server/${u}/messages/`);n(a)}catch(a){console.error("Fetch highlights error:",a)}},c=async()=>{try{await k.post(`/highlights/server/${u}/config/`,t),T.success("âœ… Highlight ayarlarÄ± kaydedildi")}catch(a){console.error("Save config error:",a),T.error("âŒ Kaydetme hatasÄ±")}},h=()=>{if(g.trim()){if(t.keywords.includes(g.toLowerCase())){T.warning("âš ï¸ Bu kelime zaten ekli");return}i({...t,keywords:[...t.keywords,g.toLowerCase()]}),E("")}},w=a=>{i({...t,keywords:t.keywords.filter(d=>d!==a)})},o=async()=>{if(window.confirm("TÃ¼m highlight geÃ§miÅŸini temizlemek istediÄŸinize emin misiniz?"))try{(await fetch(`${apiBaseUrl}/highlights/server/${u}/clear/`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}})).ok&&(T.success("âœ… GeÃ§miÅŸ temizlendi"),n([]))}catch{T.error("âŒ Temizleme hatasÄ±")}};return s.createElement("div",{className:"highlights-overlay",onClick:e},s.createElement("div",{className:"highlights-panel",onClick:a=>a.stopPropagation()},s.createElement("div",{className:"highlights-header"},s.createElement("h2",null,"âœ¨ Highlight Sistemi"),s.createElement("button",{className:"close-btn",onClick:e},"Ã—")),s.createElement("div",{className:"highlights-content"},p?s.createElement("div",{className:"loading-state"},s.createElement("div",{className:"spinner"}),s.createElement("p",null,"YÃ¼kleniyor...")):s.createElement(s.Fragment,null,s.createElement("div",{className:"config-section"},s.createElement("div",{className:"section-header"},s.createElement("h3",null,"âš™ï¸ Ayarlar"),s.createElement("label",{className:"toggle-switch"},s.createElement("input",{type:"checkbox",checked:t.enabled,onChange:a=>i({...t,enabled:a.target.checked})}),s.createElement("span",{className:"toggle-slider"}))),s.createElement("div",{className:"keywords-section"},s.createElement("h4",null,"ðŸ”‘ Anahtar Kelimeler"),s.createElement("div",{className:"keyword-input"},s.createElement("input",{type:"text",value:g,onChange:a=>E(a.target.value),onKeyPress:a=>a.key==="Enter"&&h(),placeholder:"Kelime ekle..."}),s.createElement("button",{onClick:h},"âž•")),t.keywords.length>0&&s.createElement("div",{className:"keywords-list"},t.keywords.map((a,d)=>s.createElement("div",{key:d,className:"keyword-tag"},s.createElement("span",null,a),s.createElement("button",{onClick:()=>w(a)},"Ã—"))))),s.createElement("div",{className:"config-options"},s.createElement("div",{className:"form-group"},s.createElement("label",{className:"checkbox-label"},s.createElement("input",{type:"checkbox",checked:t.dm_notifications,onChange:a=>i({...t,dm_notifications:a.target.checked})}),s.createElement("span",null,"DM bildirimleri gÃ¶nder"))),s.createElement("div",{className:"form-group"},s.createElement("label",null,"Highlight Rengi"),s.createElement("input",{type:"color",value:t.highlight_color,onChange:a=>i({...t,highlight_color:a.target.value})}))),s.createElement("button",{className:"save-btn",onClick:c},"ðŸ’¾ Kaydet")),s.createElement("div",{className:"highlights-section"},s.createElement("div",{className:"section-header"},s.createElement("h3",null,"ðŸ“ Highlight GeÃ§miÅŸi (",r.length,")"),r.length>0&&s.createElement("button",{className:"clear-btn",onClick:o},"ðŸ—‘ï¸ Temizle")),r.length===0?s.createElement("div",{className:"empty-state"},s.createElement("span",{className:"empty-icon"},"âœ¨"),s.createElement("p",null,"HenÃ¼z highlight yok")):s.createElement("div",{className:"highlights-list"},r.map(a=>s.createElement("div",{key:a.id,className:"highlight-card"},s.createElement("div",{className:"highlight-header"},s.createElement("div",{className:"highlight-author"},a.author_avatar?s.createElement("img",{src:a.author_avatar,alt:""}):s.createElement("div",{className:"default-avatar"},"ðŸ‘¤"),s.createElement("div",{className:"author-info"},s.createElement("span",{className:"author-name"},a.author_name),s.createElement("span",{className:"channel-name"},"# ",a.channel_name))),s.createElement("span",{className:"highlight-time"},new Date(a.created_at).toLocaleString("tr-TR"))),s.createElement("div",{className:"highlight-content"},s.createElement("p",{dangerouslySetInnerHTML:{__html:b.sanitize(a.content.replace(new RegExp(`(${t.keywords.join("|")})`,"gi"),`<mark style="background: ${t.highlight_color}; color: #000; padding: 2px 4px; border-radius: 4px;">$1</mark>`))}}))))))))))};export{P as default};
