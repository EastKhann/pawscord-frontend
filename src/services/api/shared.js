// Shared helpers for nice-to-have API services
// Auto-generated by split_nice_to_have_api.py ‚Äî Enhanced with error handling

import { API_BASE } from '../../config';

export const getAuthHeaders = () => ({
    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
    'Content-Type': 'application/json'
});

/**
 * üõ°Ô∏è Resilient fetch wrapper for services/api layer.
 * - Adds auth headers automatically
 * - Checks response.ok ‚Üí throws descriptive error on failure
 * - Token expired (401) ‚Üí triggers auth:logout event
 * - Network error ‚Üí returns null (caller gets null instead of crash)
 */
export const apiFetch = async (url, options = {}) => {
    const headers = { ...getAuthHeaders(), ...options.headers };

    // Remove Content-Type for FormData (browser sets boundary automatically)
    if (options.body instanceof FormData) {
        delete headers['Content-Type'];
    }

    try {
        const response = await fetch(url, { ...options, headers, credentials: 'include' });

        if (response.status === 401) {
            // Token expired ‚Äî trigger logout
            window.dispatchEvent(new CustomEvent('auth:logout'));
            return null;
        }

        if (!response.ok) {
            // Log but don't crash ‚Äî caller handles null
            console.warn(`‚ö†Ô∏è [API] ${options.method || 'GET'} ${url} ‚Üí ${response.status}`);
            return null;
        }

        // Handle 204 No Content
        if (response.status === 204) return { success: true };

        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
            return await response.json();
        }

        // Non-JSON response (blob, text, etc.)
        return await response.text();
    } catch (error) {
        // Network error (offline, DNS, CORS, etc.)
        console.warn(`‚ö†Ô∏è [API] Network error: ${options.method || 'GET'} ${url}`, error.message);
        return null;
    }
};

export { API_BASE };
